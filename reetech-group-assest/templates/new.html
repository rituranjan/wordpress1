<meta name="viewport" content="width=900" />
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<link rel="shortcut icon" href="/wordpress1/reetech-group-assest/images/favicon.ico?v=1" />
<link rel="stylesheet" type="text/css" href="/wordpress1/reetech-group-assest/__common/css/common.css?v=V0002469" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="/wordpress1/reetech-group-assest/javascript/error_report.js" type="application/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


<link rel="stylesheet" type="text/css" href="/wordpress1/reetech-group-assest/css/module.css?v=V0002469" />
<script type="text/javascript" src="/wordpress1/reetech-group-assest/javascript/ajaxupload.js?v=V0002469"></script>

<style>
    .isDiscount select {
        display: none;
    }

    .isDiscount .select:after {
        content: "";
    }

    .isDiscount .select:before {
        content: "Discount";
        display: block;
        padding-left: 5px;
    }

    .isExpense select {
        display: none;
    }

    .isExpense .select:after {
        content: "";
    }

    .isExpense .select:before {
        content: "Expense";
        display: block;
        padding-left: 5px;
    }

    .isInventory select {
        display: none;
    }

    .isInventory .select:after {
        content: "";
    }

    .isInventory .select:before {
        content: "Product";
        display: block;
        padding-left: 5px;
    }

    .btn.btn-xs {
        line-height: 25px !important;
        font-size: 11px !important;
        padding: 0 12px !important;
    }

    #tableTaxes .sum-label {
        white-space: normal;
        word-wrap: break-word !important;
        word-break: break-all;
        width: 170px;
    }

    .openTaxDropdown.dropdown-toggle:not(.placeholder) {
        color: inherit;
    }

    /* #dateEnd,
        #dateStart {
            color: inherit;
            background-color: #fff;
            border: thin solid #aaa;
            border-color: #939393 #c1c1c1 #c1c1c1 #939393;
            border-radius: 0;
        }

        #dateEnd:focus,
        #dateStart:focus {
            background-color: #fffbe6;
            border-color: #3892db #9edbff #9edbff #3892db;
        } */
</style>


<style>
    #tablePaginatorFirstPage,
    #tablePaginatorPreviousPage,
    #tablePaginatorCurrentPage,
    #tablePaginatorNextPage,
    #tablePaginatorLastPage,
    #tablePaginatorAllPages {
        line-height: normal !important;
        padding: 3px 6px !important;
        width: unset !important;
    }

    #innerSendForm * {
        box-sizing: content-box !important;
        line-height: normal;
    }

    #invoiceFormWrapper * {
        box-sizing: content-box !important;
    }

    #divWithInfoMessage td {
        padding: 4px !important;
    }

    .divWithFilter input {
        box-sizing: content-box !important;
    }

    #div2 {
        margin-left: -250px;
        left: 50% !important;
    }

    #recordPayment_date {
        box-sizing: content-box !important;
    }

    tr.recordPayment_paymentHistoryTR>td {
        padding-top: 5px !important;
        padding-bottom: 5px !important;
    }

    tr.recordPayment_paymentHistoryTR>td img {
        margin-top: 3px !important;
    }

    .btn {
        padding: 0 16px !important;
        line-height: 30px !important;
    }

    .btn.btn-lg {
        padding: 2px 19px !important;
        box-shadow: none !important;
        border: 0.9px solid #aaa !important;
        line-height: 30px !important;
    }

    th.table-dropdown .btn,
    td.table-dropdown .btn {
        height: 19px !important;
        line-height: 19px !important;
        padding: 0 !important;
    }

    #top-menu .dropdown-item:hover,
    #top-menu .dropdown-item:active,
    #utilities .dropdown-item:hover,
    #utilities .dropdown-item:active {
        box-shadow: none;
        border: none;
        text-decoration: none;
        background-color: #54a0e7;
        color: #fff;
    }

    #no-js-message {
        display: none;
        font-size: 13px;
        line-height: 19px;
        font-weight: normal !important;
        text-align: center;
        max-width: 800px;
        margin: 1em auto;
        background-color: #fffadc !important;
        border: 2px solid #fcf5cd !important;
        padding: 8px 40px;
    }

    .alert-danger,
    .bg-danger {
        background: #FFFADC url('../../images/red_error_25.gif') 6px 6px no-repeat !important;
    }

    .alert-danger:before {
        content: none !important;
    }

    /* hack to avoid having the icon in v3 overlaping the icon in v2 */
</style>

<noscript>
    <style>
        #no-js-message {
            display: block;
        }
    </style>
</noscript>
<script src="/wordpress1/reetech-group-assest/javascript/bootstrap.min.js?v=V0002469"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
<!-- <script src="/wordpress1/reetech-group-assest/javascript/javascript.js?v=V0002467"></script> -->
<!-- <script src="/wordpress1/reetech-group-assest\javascript\invoice\Invoice.js"></script> 
    -->









<div class="page-body">
    <div class="row mb-3">
        <div class="col-12 p-3">


            <div class="container">

                <div class="page-header">


                    <h1>New Invoice</h1>
                    <button type="button" id="btnToggleOptions">Show Customization Options</button>
                </div>

                <div class="feedback-messages">

                    <div class="alert alert-danger " id="pageError">
                        <button type="button" class="close" aria-hidden="true"></button>
                        <span class="msg"></span>
                    </div>


                    <div class="alert alert-success " id="pageSuccess">
                        <button type="button" class="close" aria-hidden="true"></button>
                        <span class="msg"></span>
                    </div>


                    <div class="alert alert-warning " id="pageWarning">
                        <button type="button" class="close" aria-hidden="true"></button>
                        <span class="msg"></span>
                    </div>


                    <div class="alert alert-info " id="pageInfo">
                        <button type="button" class="close" aria-hidden="true"></button>
                        <span class="msg"></span>
                    </div>

                    <div class="alert alert-info " id="pageUpgrade">
                        <button type="button" class="close" aria-hidden="true"></button>
                        <span class="msg"></span>
                    </div>








                </div>


                <form id="invoice_form" name="invoice_form" action="" method="post" enctype="multipart/form-data"
                    autocomplete="off">


                    <div id="options" class="hidden-print">
                        <div class="options-container">

                            <label class="option label-checkbox">
                                <input type="checkbox" onclick="toggleLogo()" name="customization_logo"
                                    id="customization_logo" class="form-check-input">
                                <span>Logo</span>
                            </label>

                            <label class="option label-checkbox">
                                <input type="checkbox" name="customization_poNumber" id="customization_poNumber"
                                    class="form-check-input">
                                <span>P.O. #</span>
                            </label>
                            <label class="option label-checkbox">
                                <input type="checkbox" name="customization_tax" id="customization_tax"
                                    class="form-check-input">
                                <span>Sales Tax</span>
                            </label>

                            <label class="option label-checkbox taxItem" style="display:none">
                                <input type="checkbox" name="customization_tax2" id="customization_tax2"
                                    class="form-check-input">
                                <span>Show Tax Column</span>

                                <span class="has-tooltip">
                                    <i class="material-icons help" style="opacity:.4">&#xe887;</i>
                                    <i class="tip">Affects only the finished invoice,<br>not the template below.</i>
                                </span>
                            </label>

                        </div>
                    </div>




                    <table class="nav-content">
                        <tr>



                            <td class="minify">
                                <button type="button" class="btn has-tooltip tooltip-bottom btn-primary" tabindex="-1"
                                    sel="btnView">View <i class="tip">Please save your invoice
                                        first.</i></button>
                            </td>
                            <td class="minify">
                                <button type="button" class="btn has-tooltip tooltip-bottom btn-primary" tabindex="-1"
                                    sel="btnPrint">Print <i class="tip">Please save your invoice
                                        first.</i></button>
                            </td>
                            <td class="minify">
                                <button type="button" class="btn has-tooltip tooltip-bottom btn-primary" tabindex="-1"
                                    sel="btnPDF">PDF <i class="tip">Please save your invoice
                                        first.</i></button>
                            </td>
                            <td class="minify">
                                <button type="button" class="btn has-tooltip tooltip-bottom btn-primary" tabindex="-1"
                                    sel="btnSend">Send <i class="tip">Please save your invoice
                                        first.</i></button>
                            </td>
                            <td class="minify">
                                <button type="button" class="btn has-tooltip tooltip-bottom btn-primary" tabindex="-1"
                                    sel="btnPaid">Mark as Paid <i class="tip">Please save your invoice
                                        first.</i></button>


                            </td>


                            <td></td>

                            <td class="minify">
                                <button type="button" onclick="submitInvoiceToWordPress()"
                                    class="btn has-tooltip tooltip-bottom btn-primary">Save Invoice</button>


                            </td>
                        </tr>
                    </table>


                    <input type="hidden" name="submitButton" id="submitButton">

                    <input type="hidden" name="c" value="">
                    <input type="hidden" name="emailaddress_logged_in" value="rituranjan.gupta2@gmail.com">

                    <input type="hidden" name="deleted" id="deleted" value="0">

                    <input type="hidden" name="status" id="status" value="">



                    <div id="modeEdit" class="paper">

                        <div class="meta">

                            <div class="meta-left">

                                <table class="form-invoice">

                                    <tr>
                                        <td>
                                            <h2>From</h2>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td>

                                            <input type="text" name="from_name" id="from_name"
                                                onkeyup="sanitizeNames(this);" value="test" maxlength="500"
                                                placeholder="Your Name" class="form-control">

                                        </td>
                                    </tr>

                                    <tr>
                                        <td>


                                            <textarea name="from_address" id="from_address" rows="1"
                                                style="min-height:86px" class="growTextarea form-control"
                                                maxlength="1000" placeholder="Your address">test1</textarea>


                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="padding-top:20px">
                                            <h2>To</h2>
                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="dropdown-toggle select">


                                            <select name="to_id" id="to_name" onchange="getCustomerAddress(this.value);"
                                                class="form-select">

                                                <option value="29632911">customer1</option>
                                                <optgroup label="-----------------------------">
                                                    <option value="0" selected>New Customer</option>

                                            </select>

                                        </td>
                                    </tr>

                                    <tr id="rowNewCustomer" style="">
                                        <td>


                                            <input type="text" name="to_new_customer" id="to_new_customer"
                                                onkeyup="sanitizeNames(this);" value="" maxlength="200"
                                                placeholder="Customer name" class="form-control">

                                        </td>
                                    </tr>

                                    <tr>
                                        <td>


                                            <textarea name="to_address" id="to_address" rows="1" style="min-height:86px"
                                                class="growTextarea form-control" maxlength="1000"
                                                placeholder="Customer address"></textarea>

                                        </td>
                                    </tr>

                                </table>


                            </div>
                            <!--end meta-left-->

                            <div class="meta-right">

                                <div class="meta-top-right">





                                    <div class="upload-container">

                                        <div id="upload_area" style="display:none">
                                        </div>

                                        <div class="clearfix"></div>


                                        <div class="clearfix">

                                            <div id="btnDeleteLogo" style="display:none;">
                                                <button type="button" class="btn btn-xs right"
                                                    onclick="deleteLogo();">Delete Logo</button>
                                            </div>

                                            <label id="btnUploadLogo" class="input-file">
                                                <b class="btn btn-xs right">Browse...</b>
                                                <input name="filename" type="file" id="logo_file_input"
                                                    accept=".jpg, .jpeg, .gif, .bmp, .png">
                                            </label>

                                        </div>





                                        <input type="text" style="display:none;" name="customization_logoFilename"
                                            id="customization_logoFilename" onchange="updateLogo()" value=""
                                            class="form-control">


                                    </div>


                                    <input type="text" name="invoice_heading" id="doc_heading"
                                        class="meta-title right form-control" value="INVOICE" maxlength="50">

                                </div>

                                <div class="clearfix">

                                    <table class="form-invoice dates">
                                        <tr>
                                            <td class="label-header">

                                                Invoice #

                                            </td>
                                            <td>

                                                <input type="text" name="invoice_number" id="doc_number"
                                                    class="form-control" onkeyup="onlyNumbersLettersOrDashes(this)"
                                                    value="0000003" maxlength="55">

                                            </td>
                                        </tr>




                                        <tr id="po_numberTR" style="display:none;">
                                            <td class="label-header">P.O. #</td>
                                            <td>

                                                <input type="text" name="po_number" id="po_number" class="form-control"
                                                    onkeyup="onlyNumbersLettersOrDashes(this)" value="" maxlength="55">

                                            </td>
                                        </tr>
                                    </table>

                                    <div class="form-invoice input-daterange dateRange">
                                        <span class="label">Invoice Date</span>
                                        <input type="text" name="invoice_date" id="dateStart" value="03/31/2025"
                                            maxlength="55" class="form-control">

                                        <span class="label end">Due Date</span>
                                        <input type="text" name="payment_due_date" id="dateEnd" value="03/31/2025"
                                            maxlength="55" class="form-control">
                                    </div>

                                </div>
                                <!--end clearfix-->

                            </div>
                            <!--end meta-right-->

                        </div>
                        <!--end meta-->




                        <table id="dataTable" class="table-record ">

                            <tbody>
                                <tr>


                                    <th>

                                    </th>

                                    <th style="width:86px">Item</th>

                                    <th>Description</th>

                                    <th style="width:80px" class="text-right">Unit Price</th>

                                    <th style="width:80px" class="text-right">Quantity</th>

                                    <th style="width:80px; padding-right:12px; display:none;"
                                        class="text-right taxItem">Tax
                                    </th>

                                    <th style="width:80px" class="text-right">Amount</th>

                                </tr>


                                <tr class="line ">

                                    <td class="zap has-tooltip tooltip-left">

                                        <!-- ZAP -->
                                        <button tabindex="-1" type="button" class="btnDeleteRow btn-zap" style="">
                                            <i class="material-icons">&#xe5c9;</i>
                                        </button>
                                        <i class="tip">Delete Line</i>
                                    </td>


                                    <td class="dropdown-toggle select item">


                                        <select class="noborder selectItem permEx" onfocusin="objSelected=this;"
                                            name="item[]" id="itemSelect0">

                                            <option value=""></option>
                                            <option value="Service">Service</option>
                                            <option value="Hours">Hours</option>
                                            <option value="Days">Days</option>
                                            <option value="Product">Product</option>
                                            <option value="Expense" selected="selected">Expense</option>
                                            <option value="Discount_aynax">Discount</option>
                                        </select>
                                    </td>


                                    <td>

                                        <div class="dropdown">
                                            <textarea name="description[]" id="description[]" rows="1" maxlength="2000"
                                                class="growTextarea lineDescription hasAutocomplete"></textarea>





                                        </div>
                                        <!--end dropdown-->

                                    </td>


                                    <td class="price">

                                        <input type="text" name="unit_price[]" id="unit_price[]"
                                            class="text-right linePrice numbersOnly" value="" maxlength="20"
                                            placeholder="0.00">

                                    </td>

                                    <td class="qty">

                                        <input type="text" name="qty[]" id="qty[]"
                                            class="text-right lineQty numbersOnly" value="" maxlength="20"
                                            placeholder="0.00">

                                    </td>


                                    <td class="tax1 taxItem" style="display:none">


                                        <input type="hidden" name="tax_total[]" id="tax_total[]" class="tax_total"
                                            value="0.00">

                                        <input type="hidden" name="tax[]" class="tax_rate" value="">
                                        <input type="hidden" name="tax2[]" class="tax2_rate" value="">
                                        <input type="hidden" name="tax3[]" class="tax3_rate" value="">

                                        <input type="hidden" name="tax_id[]" class="tax_id" value="">
                                        <input type="hidden" name="tax2_id[]" class="tax2_id" value="">
                                        <input type="hidden" name="tax3_id[]" class="tax3_id" value="">




                                        <div class="dropdown">

                                            <button type="button"
                                                class="openTaxDropdown dropdown-toggle noborder placeholder"
                                                data-groupid="">
                                                <span class="jtaxTotal">0.00% </span>
                                            </button>


                                            <div class="dropdown-menu dropdown-menu-right taxDropdown"
                                                style="max-height:300px">

                                                <label class="dropdown-item">
                                                    <input onclick="changeTaxSelect(this);" type="checkbox"
                                                        class="NoTax" data-tax="0" checked>
                                                    <span>No Tax</span>
                                                </label>

                                                <hr>


                                                <hr>
                                                <button type="button" class="dropdown-item NewTax"
                                                    onclick="changeTaxSelect(this);">
                                                    <i class="icon-new">&nbsp;</i> <span>New Tax</span>
                                                </button>

                                            </div>

                                        </div>
                                    </td>



                                    <td class="amount"
                                        onclick="alert('The amount is calculated automatically as soon as you have entered something into both the unit price and the quantity field. \n\n Example: If you wish to enter a service for $100.00, you should enter 100.00 in the unit price field and 1.00 in the quantity field.')">

                                        <input type="text" tabindex="-1" name="total[]" id="total[]" class="lineTotal"
                                            value="0.00" readonly>

                                    </td>

                                    <input type="hidden" name="expense_id[]" value="">

                                </tr>



                                <tr class="line ">

                                    <td class="zap has-tooltip tooltip-left">

                                        <!-- ZAP -->
                                        <button tabindex="-1" type="button" class="btnDeleteRow btn-zap" style="">
                                            <i class="material-icons">&#xe5c9;</i>
                                        </button>
                                        <i class="tip">Delete Line</i>
                                    </td>


                                    <td class="dropdown-toggle select item">


                                        <select class="noborder selectItem permEx" onfocusin="objSelected=this;"
                                            name="item[]" id="itemSelect1">

                                            <option value="" selected="selected"></option>
                                            <option value="Service">Service</option>
                                            <option value="Hours">Hours</option>
                                            <option value="Days">Days</option>
                                            <option value="Product">Product</option>
                                            <option value="Expense">Expense</option>
                                            <option value="Discount_aynax">Discount</option>
                                        </select>
                                    </td>


                                    <td>

                                        <div class="dropdown">
                                            <textarea name="description[]" id="description[]" rows="1" maxlength="2000"
                                                class="growTextarea lineDescription hasAutocomplete"></textarea>





                                        </div>
                                        <!--end dropdown-->

                                    </td>


                                    <td class="price">

                                        <input type="text" name="unit_price[]" id="unit_price[]"
                                            class="text-right linePrice numbersOnly" value="" maxlength="20"
                                            placeholder="0.00">

                                    </td>

                                    <td class="qty">

                                        <input type="text" name="qty[]" id="qty[]"
                                            class="text-right lineQty numbersOnly" value="" maxlength="20"
                                            placeholder="0.00">

                                    </td>


                                    <td class="tax1 taxItem" style="display:none">


                                        <input type="hidden" name="tax_total[]" id="tax_total[]" class="tax_total"
                                            value="0.00">

                                        <input type="hidden" name="tax[]" class="tax_rate" value="">
                                        <input type="hidden" name="tax2[]" class="tax2_rate" value="">
                                        <input type="hidden" name="tax3[]" class="tax3_rate" value="">

                                        <input type="hidden" name="tax_id[]" class="tax_id" value="">
                                        <input type="hidden" name="tax2_id[]" class="tax2_id" value="">
                                        <input type="hidden" name="tax3_id[]" class="tax3_id" value="">




                                        <div class="dropdown">

                                            <button type="button"
                                                class="openTaxDropdown dropdown-toggle noborder placeholder"
                                                data-groupid="">
                                                <span class="jtaxTotal">0.00% </span>
                                            </button>


                                            <div class="dropdown-menu dropdown-menu-right taxDropdown"
                                                style="max-height:300px">

                                                <label class="dropdown-item">
                                                    <input onclick="changeTaxSelect(this);" type="checkbox"
                                                        class="NoTax" data-tax="0" checked>
                                                    <span>No Tax</span>
                                                </label>

                                                <hr>


                                                <hr>
                                                <button type="button" class="dropdown-item NewTax"
                                                    onclick="changeTaxSelect(this);">
                                                    <i class="icon-new">&nbsp;</i> <span>New Tax</span>
                                                </button>

                                            </div>

                                        </div>
                                    </td>



                                    <td class="amount"
                                        onclick="alert('The amount is calculated automatically as soon as you have entered something into both the unit price and the quantity field. \n\n Example: If you wish to enter a service for $100.00, you should enter 100.00 in the unit price field and 1.00 in the quantity field.')">

                                        <input type="text" tabindex="-1" name="total[]" id="total[]" class="lineTotal"
                                            value="0.00" readonly>

                                    </td>

                                    <input type="hidden" name="expense_id[]" value="">

                                </tr>




                            </tbody>
                        </table>
                        <!-- end dataTable -->



                        <div class="button-row clearfix">
                            <button type="button" class="btn btn-xs left" sel="btnAddRow" onclick="newLineClick()">
                                <i class="icon-new">&nbsp;</i><span>New Line</span>
                            </button>


                        </div>





                        <div class="foot">

                            <div class="foot-left notes">

                                <label class="input-label">
                                    <span>Notes</span>
                                    <button type="button" class="btn-icon has-tooltip tooltip-right" data-toggle="modal"
                                        data-target="#defaultNote">
                                        <i class="material-icons">&#xe3c9;</i>
                                        <i class="tip">Edit the default note which<br> will be added to all new
                                            invoices.</i>
                                    </button>
                                </label>

                                <textarea name="invoice_notes" id="doc_notes" rows="1" style="min-height:108px;"
                                    maxlength="5000" class="growTextarea form-control"></textarea>

                            </div>
                            <!--end foot-left-->

                            <div class="foot-right">



                                <table id="table_sums" class="sums">


                                    <tr class="sum-subtotal">

                                        <td class="sum-label">
                                            Subtotal
                                        </td>

                                        <td class="sum-number">

                                            <input type="text" name="sum_subtotal" id="sum_subtotal"
                                                class="noborder nofocus text-right"
                                                onclick="alert('The subtotal is calculated automatically as soon as you have entered something into both the unit price and the quantity field in the lines above.\n\nExample: If you wish to enter a service for $100.00, you should enter 100.00 in the unit price field and 1.00 in the quantity field.')"
                                                value="0.00" readonly>

                                        </td>

                                    </tr>





                                    <tr class="sum-discount" id="sum_discountTR" style="display:none;">

                                        <td class="sum-label">
                                            <span style="display:inline-block; width:.86em">&ndash;</span> Discount
                                        </td>

                                        <td class="sum-number">

                                            <input type="text" name="sum_discount" id="sum_discount"
                                                class="noborder nofocus text-right"
                                                onclick="alert('The discount is calculated automatically as the sum of all lines with discount above.')"
                                                value="0.00" readonly>

                                        </td>

                                    </tr>



                                    <tr class="sum-taxes">
                                        <td colspan="2">

                                            <table id="tableTaxes">
                                            </table>

                                        </td>
                                    </tr>



                                    <tr class="sum-total">

                                        <td class="sum-label">
                                            Total
                                        </td>

                                        <td class="sum-number">

                                            <input type="text" name="sum_total" id="sum_total"
                                                class="noborder nofocus text-right"
                                                onclick="alert('The total is calculated automatically as soon as you have entered something into both the unit price and the quantity field in the lines above.\n\nExample: If you wish to enter a service for $100.00, you should enter 100.00 in the unit price field and 1.00 in the quantity field.')"
                                                value="0.00" readonly>

                                        </td>

                                    </tr>




                                    <tr class="sum-paid">

                                        <td class="sum-label">
                                            Amount Paid
                                        </td>

                                        <td class="sum-number">

                                            <input type="text" name="amount_paid" id="amount_paid"
                                                class="noborder nofocus text-right"
                                                onclick="alert('To enter the amount paid, first save your purchase order. Thereafter convert it to an invoice and mark this as paid.')"
                                                value="0.00" readonly>

                                        </td>

                                    </tr>



                                    <tr class="sum-balance">

                                        <td class="sum-label">
                                            Balance Due
                                        </td>

                                        <td class="sum-number">

                                            <input type="text" name="balance_due" id="balance_due"
                                                class="noborder nofocus text-right"
                                                onclick="alert('The balance due is calculated automatically as soon as you have entered something into both the unit price and the quantity field in the lines above.\n\nExample: If you wish to enter a service for $100.00, you should enter 100.00 in the unit price field and 1.00 in the quantity field')"
                                                value="$" readonly>

                                        </td>

                                    </tr>

                                </table>
                                <!-- end table_sums -->


                            </div>
                        </div>

                        <input type="hidden" id="lastDocFormInput" name="lastDocFormInput" value="POST_OK">



                    </div>
                    <!--end #modeEdit-->


                    <div class="shown-print">



                        <div id="modePreview">
                            <div class="paper">


                                <div class="view-header">
                                    <div class="view-left">

                                        <address class='view-from'>
                                            test <br>
                                            test1 </address>


                                        <address class='view-to'>
                                            <br>
                                        </address>


                                    </div>
                                    <div class="view-right ">


                                        <h1 class="view-headline "></h1>


                                        <table class="view-dates">

                                            <tr>
                                                <td>
                                                    <b class="nowrap">Invoice #</b>
                                                </td>
                                                <td class="view-invoice-number">
                                                    0000003 </td>
                                            </tr>


                                            <tr>
                                                <td>
                                                    <b>Invoice Date</b>
                                                </td>
                                                <td>
                                                    03/31/2025 </td>
                                            </tr>

                                            <tr>
                                                <td>
                                                    <b>Due Date</b>
                                                </td>
                                                <td>
                                                    03/31/2025 </td>
                                            </tr>

                                        </table>

                                    </div>
                                </div>





                                <table class="view-datatable without-notes">

                                    <tbody>
                                        <tr>
                                            <th class="col-item">Item</th>
                                            <th class="col-desc">Description</th>
                                            <th class="col-price text-right">Unit Price</th>
                                            <th class="col-qty text-right">Quantity</th>
                                            <th class="col-amount text-right">Amount</th>
                                        </tr>




                                    </tbody>
                                </table>


                                <table class="view-sums">
                                    <tbody>




                                        <tr>
                                            <td rowspan="7" class="border-right" style="width:58%;">

                                                &nbsp;

                                            </td>
                                            <td style="padding-top:7px;padding-bottom:5px;padding-left:35px;">

                                                <b>Subtotal</b>

                                            </td>
                                            <td class="min text-right" style="padding-top:7px;padding-bottom:5px;">

                                                0.00
                                            </td>
                                        </tr>


                                        <tr>
                                            <td class="border-top"
                                                style="padding-top:7px;padding-bottom:4px;padding-left:35px;">
                                                <b>Total</b>
                                            </td>
                                            <td class="min text-right border-top"
                                                style="padding-top:7px;padding-bottom:4px;">
                                                0.00 </td>
                                        </tr>

                                        <tr>
                                            <td style="padding-top:4px;padding-bottom:7px;padding-left:35px;">
                                                <b>Amount Paid</b>
                                            </td>
                                            <td class="min text-right" style="padding-top:4px;padding-bottom:7px;">
                                                0.00 </td>
                                        </tr>

                                        <tr>
                                            <td class="bg-grey border-top"
                                                style="padding-top:7px;padding-bottom:7px;padding-left:35px;">
                                                <b>Balance Due</b>
                                            </td>
                                            <td class="min text-right bg-grey border-top"
                                                style="padding-top:7px;padding-bottom:7px;">$0.00 </td>
                                        </tr>

                                    </tbody>
                                </table>


                            </div>
                        </div>
                        <!--end #modePreview-->
                    </div>


                    <div class="modal" id="modalSave" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">

                                <div class="modal-header">
                                    <button type="button" class="close" aria-hidden="true"
                                        data-dismiss="modal"></button>
                                    <h4 class="modal-title">Save your work</h4>
                                </div>
                                <div class="modal-body">

                                    <p>You have unsaved changes. Save first?</p>

                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary btnSubmit"
                                        onclick="document.getElementById('submitButton').value='Save'">Save</button>
                                    <button type="button" class="btn btn-cancel" data-dismiss="modal">Cancel</button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- end modal -->

                    <div class="modal" id="defaultNote" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog modal-med" style="width:670px">
                            <div class="modal-content">

                                <div class="modal-header">
                                    <button type="button" class="close" aria-hidden="true"
                                        data-dismiss="modal"></button>
                                    <h4 class="modal-title">Edit Default Notes</h4>
                                </div>

                                <!--Show on opening modal-->
                                <div id="modalForm">

                                    <div class="modal-body" style="padding:50px 60px;">

                                        <textarea maxlength="1000" name="default_note" id="default_note"
                                            class="growTextarea" style="min-height:120px" maxlength="1000"></textarea>

                                        <label class="label-checkbox" style="margin-top:6px; font-size:92%">
                                            <input type="checkbox" id="copy_to_current_document" checked>
                                            <span>Add the default notes to the current invoice (max 1000
                                                characters).</span>
                                        </label>

                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" id="btnSaveDefaultNote">Save
                                            Default
                                            Note</button>
                                        <button type="button" class="btn btn-cancel"
                                            data-dismiss="modal">Cancel</button>
                                    </div>


                                </div>

                                <!--Show after Save-->
                                <div id="modalFeedback" style="display:none">


                                    <div class="modal-body" style="padding:50px 60px;">

                                        <div class="alert alert-success"><ins class="feedbackMessage"></ins></div>

                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                                    </div>

                                </div>


                            </div>
                        </div>
                    </div>
                    <!-- end modal -->



                    <script>
                        function showFeedback(status) {

                            var msg;

                            if (status == 'success') {
                                msg = 'Your default note was successfully updated!'
                            } else {
                                msg = 'There was an error updating your default message.  Please try again later or contact support.'
                            }

                            $('#modalForm').hide();
                            $('#modalFeedback').find('.feedbackMessage').text(msg);
                            $('#modalFeedback').show();
                        }

                        $(function () {


                            //reset modal
                            $('#defaultNote').on('show.bs.modal', function (e) {

                                $('#modalForm').find('.btn-spinner').prop('disabled1 btn-outline-primary', false).removeClass('btn-spinner');
                                $('#modalForm').show();
                                $('#modalFeedback').hide();

                            })


                            var request;

                            $('#btnSaveDefaultNote').click(function () {

                                //disable this button & add spinner
                                $(this).prop('disabled1 btn-outline-primary', true).addClass('btn-spinner');
                                //reenable button if form fails to submit the first time
                                setTimeout(function () {
                                    $(this).prop('disabled1 btn-outline-primary', false).removeClass('btn-spinner');
                                }, 6000);


                                var notes = $('#default_note').val();
                                var newdata = "type=invoices&notes=" + encodeURIComponent(notes);

                                //Update the main form's notes to match
                                if (document.getElementById('copy_to_current_document').checked) document.getElementById('doc_notes').value = notes;

                                // Abort any pending request to server
                                if (request) {
                                    request.abort();
                                }

                                request = $.ajax({
                                    url: "/app/invoices/defaultnotes",
                                    type: "post",
                                    data: newdata
                                });

                                // Callback handler that will be called on success
                                request.done(function (response, textStatus, jqXHR) {

                                    showFeedback('success');

                                });

                                // Callback handler that will be called on failure
                                request.fail(function (jqXHR, textStatus, errorThrown) {

                                    showFeedback('error');

                                });

                                $('#default_note').each(growTextarea);

                            });



                        })
                    </script>
                </form>


            </div>
        </div>
    </div>

</div>
<!-- end page-body -->



<div class="modal" id="salesTaxModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-med" style="width:670px">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" aria-hidden="true" data-dismiss="modal"></button>
                <h4 class="modal-title">New Tax Rate</h4>
            </div>
            <div class="modal-body" style="padding:50px 20px 60px 20px; position:relative;">

                <div style="width:100%; max-width:440px; margin:0 auto;">

                    <table class="form" id="tableNewTax">
                        <tr>
                            <td style="width:75%;">

                                <label class="label">Tax Name</label>
                                <input type="text" id="singleTaxName" value="Tax" maxlength="20" autocomplete="nope">

                            </td>
                            <td style="width:25%;">

                                <label class="label">Tax Rate</label>
                                <input type="text" id="singleTaxRate" maxlength="6" value=""
                                    onkeyup="onlyNumbersRate(this)" placeholder="0.00">

                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">

                                <label class="label">Method</label>
                                <select id="singleMethod">
                                    <option value="0">Accrual</option>
                                    <option value="1">Cash</option>
                                </select>

                            </td>
                        </tr>
                    </table>


                    <div class="modal-error"></div>


                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btnSaveTax" onclick="saveSingleTax();">Save</button>
                <button type="button" class="btn btn-cancel" data-dismiss="modal">Cancel</button>
            </div>
        </div>

    </div>
</div>
</div>
<!-- end modal -->



<script>
    var table = $('#dataTable');

    table.on('click', '.openTaxDropdown', function (e) {
        var dd = $(this).closest('.dropdown');
        dd.find('.dropdown-menu').toggle();
    });

    $('#salesTaxModal').on('hide.bs.modal', function (e) {

        clearSingleTax();

        //In the case that just No Tax was checked prior to checking New Tax, need to recheck No Tax:	
        var rowNumber = $('body').data('selectedRow');
        var row = table.find('tr').eq(rowNumber);
        var taxDropdown = row.find('.taxDropdown :input:checked');

        // If no checkboxes are checked in this row:
        if (taxDropdown.length == 0) {
            row.find('.NoTax').prop("checked", true);
            row.find('.openTaxDropdown').addClass('placeholder');
        }

    });

    function clearSingleTax() {

        $('#tableNewTax').find('input').val('');
        $('#singleTaxName').val('Tax');
        $('#salesTaxModal').find('.modal-error').hide();
        $('.has-error').removeClass("has-error");

    }

    function displayTaxError(msg, id) {

        $('#salesTaxModal').find('.modal-error').html(msg).show();
        $('#' + id).addClass("has-error");
        $('#btnSaveTax').prop("disabled1 btn-outline-primary", false).removeClass('btn-spinner');

    }

    function saveSingleTax() {

        $('#btnSaveTax').prop('disabled1 btn-outline-primary', true).addClass('btn-spinner');

        var data = {
            name: $('#singleTaxName').val().trim(),
            tax: $('#singleTaxRate').val().trim(),
            method: $('#singleMethod').val().trim(),
            single_tax_save: true,
            listSalesTax: true
        };

        if (data.name == '') {

            displayTaxError('Sales tax name cannot be blank. Please fill in the required field.', 'singleTaxName');
            return;
        }

        if (data.tax == '') {

            displayTaxError('Tax rate cannot be blank. Please fill in the required field.', 'singleTaxRate');
            return;
        }

        if (parseFloat(data.tax) == 0) {

            displayTaxError('Tax rate cannot be 0.00. Please fill in the required field.', 'singleTaxRate');
            return;
        }

        if (parseFloat(data.tax) > 100.00) {
            displayTaxError('Tax rate cannot be greater than 100%.', 'singleTaxRate');
            return;
        }


        $.ajax({
            url: '/salesTax.php',
            type: 'POST',
            cache: false,
            dataType: 'json',
            async: true,
            beforeSend: function () {

            },
            complete: function () {
                $('#btnSaveTax').prop("disabled1 btn-outline-primary", false).removeClass('btn-spinner');
            },
            data: data,
            success: function (response) {
                if (response && response.success) {
                    populateTaxComponents(response.single);
                    $('#salesTaxModal').modal('hide');
                    $('#btnSaveTax').prop("disabled1 btn-outline-primary", false).removeClass('btn-spinner');
                } else {
                    var msg = (response ? response.error : "An error occurred while saving. Please try again.");
                    displayTaxError(msg, response.field);
                }
            },
            error: function () {
                aynaxConsoleLog("Response error");
                displayTaxError("An error occurred while saving. Please try again.");
            }
        });



    }

    function populateTaxComponents(single) {


        var rowNumber = $('body').data('selectedRow');

        //Retrieve the taxes in the line specific dropdown that triggered the save event:	
        tax_dropdown = table.find('tr').eq(rowNumber).find('.taxDropdown').find('.dropdown-item');

        //Locate the tax-id of the tax-component following alphabetically and find number of checked taxes:
        var line_id = 0;
        var num_checked = 0;
        //var found=false;

        $.each(tax_dropdown, function (i, obj) {

            //"No Tax" should always be on top and should not be counted in checked taxes, so skipping i=0:
            if (i != 0) {

                //Add number of checked taxes (not including last element in list which is "New Tax"):
                if (i < (tax_dropdown.length - 1) && $(obj).find('input').is(':checked')) num_checked++;

            }



        });

        //Retrieve all tax dropdowns from all lines
        tax_dropdowns = $('.taxDropdown');

        var checked = "";

        $.each(tax_dropdowns, function (i, obj) {

            //Choose location where to insert new tax (before last 'hr').
            var lastline = $(obj).closest('.taxDropdown').find('hr').last();

            num_of_decimals = Math.abs(100 * parseFloat(single.tax) - Math.round(100 * parseFloat(single.tax))) > 0 ? 3 : 2;

            lastline.before('<label class="dropdown-item"><input onclick="changeTaxSelect(this);" type="checkbox" class="SingleTax" data-name="' + single.component_name + '" data-component_id="' + single.id + '" data-tax="' + parseFloat(single.tax).toFixed(num_of_decimals) + '"  > <span>' + single.component_name + ' (' + parseFloat(single.tax).toFixed(num_of_decimals) + '%)</span></label>');


        });

        //If less than 3 taxes are selected for this specific line, autoselect the new tax for this line:
        if (num_checked < 3) {

            var new_tax = table.find('tr').eq(rowNumber).find('.taxDropdown input[data-component_id=' + single.id + ']');
            new_tax.prop("checked", true);
            updateTax(new_tax);

        }


    }

    function changeTaxSelect(obj) {

        var elem = $(obj);
        var list = elem.closest('.taxDropdown');
        var num_checked = list.find("input:checked").length;

        //Update the html to facilitate row copying:
        if (elem.is(':checked')) elem.attr("checked", true);
        else elem.attr("checked", false);

        //Find the row number and store it data-selectedRow in body-tag
        node = obj;
        while (node != null) {

            if (node.tagName == "TR") {
                rowNumber = node.rowIndex;
                break;
            }
            node = node.parentNode;
        }

        $('body').data('selectedRow', rowNumber);

        //Handle the tax selected:

        if (num_checked == 4 && elem.hasClass("SingleTax")) {

            //Uncheck the latest event:
            elem.prop("checked", false);
            alert("You cannot combine more than three tax components.");

        } else if (elem.hasClass("NewTax")) {

            list.find(".NoTax").prop("checked", false);
            $('#salesTaxModal').modal('show');

        } else if (elem.hasClass("SingleTax")) {

            list.find(".NoTax").prop("checked", false);
            updateTax(obj);

        }

        if (elem.hasClass("NoTax") || num_checked == 0) {

            list.find("input").prop("checked", false);
            list.find(".NoTax").prop("checked", true);
            updateTax(obj);

        }


        if (elem.hasClass("NoTax") || num_checked == 0) {
            elem.closest(".dropdown").find('.openTaxDropdown').addClass('placeholder');
        } else {
            elem.closest(".dropdown").find('.openTaxDropdown').removeClass('placeholder');
        }

    }

    function updateTax(obj) {

        //obj is the tax input field checked

        var total_tax = 0;
        var tax_rate = 0;
        var cell = $(obj).closest(".tax1");

        //Clear all tax-rates and tax-id's:
        cell.find(".tax_id, .tax2_id, .tax3_id").val("");
        cell.find(".tax_rate, .tax2_rate, .tax3_rate").val("");

        taxes = $(obj).closest(".taxDropdown").find(":input:checked")

        $.each(taxes, function (i, tax_obj) {

            //Set tax-rates and tax-id's:
            if (i == 0) {
                cell.find(".tax_rate").val($(tax_obj).data('tax'));
                cell.find(".tax_id").val($(tax_obj).data('component_id'));
            }
            if (i == 1) {
                cell.find(".tax2_rate").val($(tax_obj).data('tax'));
                cell.find(".tax2_id").val($(tax_obj).data('component_id'));
            }
            if (i == 2) {
                cell.find(".tax3_rate").val($(tax_obj).data('tax'));
                cell.find(".tax3_id").val($(tax_obj).data('component_id'));
            }

            //Calculate total tax
            tax_rate = parseFloat($(tax_obj).data('tax'));
            total_tax += parseFloat(tax_rate);

        });

        //Set tax_rate variable		
        num_of_decimals = Math.abs(100 * total_tax - Math.round(100 * total_tax)) > 0 ? 3 : 2;
        cell.find(".tax_total").val(total_tax.toFixed(num_of_decimals));

        //Set tax_rate display
        cell.find(".jtaxTotal").html(total_tax.toFixed(num_of_decimals) + '% ');

        //Set tax_rate color:
        if (total_tax > 0) cell.find(".currentTax").css("color", "#3c3c3c")
        else cell.find(".currentTax").css("color", "silver")

        //Recalculate tax:
        reCalculate(cell.find(".tax_total").get(0), 'dataTable', total_tax);

    }


    function onlyNumbersRate(obj) {
        var $this = $(obj);
        $this.val($this.val().replace(/[^\d.]/g, ''));
    }


    $(function () {

        $('#tableNewTax').find('input').click(function () {

            $('#salesTaxModal').find('.modal-error').hide();
            $('.has-error').removeClass("has-error");

        });


        $('#singleTaxRate').blur(function () {

            var currentValue = this.value;

            if (!currentValue) return;

            currentValue = parseFloat(currentValue);

            if (Math.abs(100 * currentValue - Math.round(100 * currentValue)) > 0.05) this.value = currentValue.toFixed(3);
            else this.value = currentValue.toFixed(2);

        });


    })
</script>

<style type="text/css">
    #modalAttachExpense .modal-dialog {
        max-width: 470px;
    }

    #modalAttachExpense .modal-body .label {
        display: block;
        width: 100%;
        padding-bottom: 4px;
    }

    #modalAttachExpense .modal .alert {
        margin: 0px 0px 25px 0px;
    }

    #modalAttachExpense .modal-title {
        margin: 0;
        line-height: 18px;
        font-size: 18px;
        font-weight: bold;
    }

    #modalAttachExpense .form-group {
        margin-bottom: 15px;
    }

    #modalAttachExpense .row {
        margin-right: -10px;
        margin-left: -10px;
    }

    #modalAttachExpense .error {
        display: none;
        color: #be1e2d;
        margin-top: 3px;
    }

    #modalAttachExpense .input-vendor {
        position: relative;
    }

    #modalAttachExpense .input-vendor input {
        padding-right: 30px;
        z-index: 0;
    }

    #modalAttachExpense .dropdown-menu {
        max-height: 320px;
        max-width: 100%;
        overflow-y: auto;
        top: 29px;
    }

    #modalAttachExpense .dropdown-radio {
        display: block;
        overflow: hidden;
    }

    #modalAttachExpense .dropdown-radio ins {
        display: block;
        padding: 6px 8px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
    }

    #modalAttachExpense :checked+ins {
        background-color: #54a0e7;
        color: #fff;
    }

    #modalAttachExpense .label {
        user-select: none;
    }

    #btnShowVendors {
        position: absolute;
        right: 0;
        line-height: 28px;
        width: 29px;
        z-index: 1;
        background: none;
        border-left: thin solid #c1c1c1;
    }

    #btnShowVendors i.material-icons {
        display: block;
    }

    #btnNewVendor.bg-muted {
        background-color: #f2f2f2;
    }

    #btnNewVendor:hover {
        background-color: #54a0e7;
        color: #fff;
    }

    .loading .dropdown.vendors {
        height: 30px;
        border: thin solid #d2d2d2;
        background-color: #f8f8f8;
    }

    .loading .input-vendor {
        opacity: 0;
    }

    .loading-input {
        display: none;
    }

    .loading .loading-input {
        display: block;
    }

    .loading-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        font-size: 12px;
        font-weight: bold;
        color: #c0c0c0;
        line-height: 29px;
        padding: 0 7px;
        user-select: none;
    }

    .loading-input .input-spinner {
        position: absolute;
        right: 5px;
        top: 7px;
    }

    .input-spinner:after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        display: block;
        border-radius: 50%;
        width: 16px !important;
        height: 16px !important;
        border: 3px solid #dadada;
        border-top-color: #73bd0b;
        animation: spin 1s infinite linear;
    }
</style>


<div class="modal" id="modalAttachExpense" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">Add an expense</h4>
            </div>
            <div class="modal-body" style="padding:20px 25px 35px 25px;">

                <div class="alert alert-danger" style="display:none"></div>

                <table class="form form-invoice" style="width:330px; max-width:100%; margin:0 auto;">
                    <tr>
                        <td>
                            <label class="label" for="inputVendor">Vendor</label>

                            <div class="dropdown vendors has-vendors">

                                <div class="input-vendor">
                                    <button type="button" id="btnShowVendors" style="display:none"><i
                                            class="material-icons arrow_drop_down">&#xe5c5;</i></button>
                                    <input type="text" id="inputVendor" class="required" autocomplete="off"
                                        placeholder="Vendor name" maxlength="200">
                                    <small class="help-block error">Please choose or enter a new vendor.</small>
                                </div>
                                <!--end input-vendor -->

                                <div class="dropdown-menu radio">
                                    <label class="dropdown-radio bg-muted" id="btnNewVendor" tabindex="0"
                                        style="display:none">
                                        <input type="radio" name="choose_vendor" tabindex="-1" value="0" checked>
                                        <ins></ins>
                                    </label>
                                    <div id="dropdownVendors">


                                    </div>
                                    <!--end dropdownVendors -->

                                </div>
                                <!--end dropdown-menu-->


                                <div class="loading-input"><span>Loading vendors...</span> <span
                                        class="input-spinner"></span></div>


                            </div>
                            <!-- end dropdown-->




                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label" for="expenseCategory">Category</label>
                            <select id="expenseCategory" style="padding:0 5px">
                                <option value="600000">Advertising</option>
                                <option value="601800">Airfare, Taxi, Lodging, etc.</option>
                                <option value="600100">Car and Truck</option>
                                <option value="600200">Commissions and Fees</option>
                                <option value="600300">Contract Labor</option>
                                <option value="600600">Employee Benefits</option>
                                <option value="601300">Equipment Rental</option>
                                <option value="600700">Insurance</option>
                                <option value="600900">Interest</option>
                                <option value="600800">Interest Mortgage</option>
                                <option value="601000">Legal and Professional Services</option>
                                <option value="601900">Meals and Entertainment</option>
                                <option value="601100">Office Expense</option>
                                <option value="600550">Payroll Tax Expense</option>
                                <option value="601200">Pensions and Profit-sharing Plans</option>
                                <option value="601400">Rent</option>
                                <option value="601500">Repairs and Maintenance</option>
                                <option value="602100">Salaries and Wages</option>
                                <option value="601600">Supplies</option>
                                <option value="601700">Taxes and Licenses</option>
                                <option value="602000">Utilities</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="input-daterange">
                            <label class="label" for="expenseDate">Date</label>
                            <input type="text" name="new_expense_due_date" id="expenseDate"
                                class="required hasDatepicker" value="03/31/2025" maxlength="30">
                            <small class="help-block error">Please enter a valid date.</small>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label" for="inputExpense">Amount</label>
                            <input type="text" name="new_expense_amount" class="text-right required" id="inputExpense"
                                autocomplete="off" placeholder="0.00" oninput="validatePositiveAmount(this)"
                                maxlength="9">
                            <small class="help-block error">Please enter a positive amount.</small>
                        </td>
                    </tr>
                </table>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="btnAttachExpense">Save expense</button>
                <button type="button" class="btn btn-cancel" data-dismiss="modal">Cancel</button>
            </div>

        </div>
    </div>
</div>
<!-- end modal -->






<script>
    var modalExpense = $('#modalAttachExpense');
    var btnNewVendor = $('#btnNewVendor');
    var btnShowVendors = $('#btnShowVendors');
    var dropdownVendors = $('#dropdownVendors');
    var inputVendor = $('#inputVendor');
    var inputExpense = $('#inputExpense');
    var btnSaveExpense = $('#btnAttachExpense');
    var modalClosedBySubmit = false;

    function showExpenseError(msg) {
        var container = modalExpense.find('.alert');
        container.html(msg).addClass('show');
    }

    function hideExpenseError() {
        var container = modalExpense.find('.alert');
        container.empty().removeClass('show');
    }

    function validatePositiveAmount(input) {
        if (input.value <= 0) {
            inputExpense.siblings('.error').show();
        } else {
            inputExpense.siblings('.error').hide();
        }
    }

    async function getVendors() {

        const vendorsList = await $.ajax({
            url: '/app/invoices/vendors',
            type: 'GET',
            dataType: 'json',
            cache: false,
            async: true
        }).catch(error => {
            showExpenseError("An error occurred while fetching vendors. Please try again.");
        })

        return vendorsList;

    }



    modalExpense.on('shown.bs.modal', async function () {
        modalClosedBySubmit = false;

        const modal = $(this);
        btnSaveExpense.prop("disabled1 btn-outline-primary", true);
        modal.addClass('loading');

        //reset previous entries
        hideExpenseError();
        btnNewVendor.hide();
        inputVendor.val('');
        //dropdownVendors.empty(); 
        inputExpense.val('');
        modalExpense.find('.error').hide();
        $('#expenseCategory').prop('selectedIndex', 0);


        //get the list of vendors
        const vendors = await getVendors();

        // enable interactions
        btnSaveExpense.prop("disabled1 btn-outline-primary", false);
        modal.removeClass('loading');

        buildList(vendors);

    });

    modalExpense.on('hidden.bs.modal', function (e) {
        if (!modalClosedBySubmit || !validateExpenseModal()) {
            var row = table.find('tr.active');
            row.removeClass(['active', 'isExpense']);
            loadDefaultItemCategories(row);
        }
    })


    function buildList(list) {
        var count = list.length;
        var htm = '';

        //remove dropdown-items
        dropdownVendors.empty();

        //add ajax list of dropdown-items
        for (var i = 0; i < count; i++) {
            htm += '<label class="dropdown-radio listItem" tabindex="0" style="display:none"';
            htm += 'data-text="' + list[i].name + '">';
            htm += '<input type="radio" name="choose_vendor" tabindex="-1"';
            htm += 'value="' + list[i].id + '">';
            htm += '<ins>' + list[i].name + '</ins></label>';

        }
        dropdownVendors.append(htm);

        if (count >= 1) {
            btnShowVendors.show()
        }

    }



    async function createVendor(vendorName) {

        const createVendorResult = await $.ajax({
            url: '/app/invoices/vendors',
            type: 'POST',
            data: {
                new_vendor: vendorName
            },
            dataType: 'json',
            cache: false,
            async: false
        }).catch(error => {
            showExpenseError("An error occurred creating vendor. Please try again.");
        })

        // on success returns: {"success":true,"inserted_vendor_id":475940}
        // on error returns: {"success":false,"error":'some error'}
        if (!createVendorResult.success) {
            showExpenseError(createVendorResult.error);
            return false;
        }

        return createVendorResult.inserted_vendor_id;

    }

    //While typing, show the closest matches in dropdown
    inputVendor.on("input", function (e) {
        var input = $(this);
        var dropdown = input.closest('.dropdown');
        var listItems = dropdown.find('.listItem');
        var radios = listItems.find('input');
        input.siblings('.error').hide(); //clear any exisitng error for the field

        if (listItems.length < 1) return;
        dropdown.addClass('open');

        if ((e.keyCode ? e.keyCode : e.which) == 13) {
            $(this).closest('.dropdown').removeClass('open');
            return; //if enter key, close dropdown and stop
        }
        if ((e.keyCode ? e.keyCode : e.which) == 9) {
            return; //if tab key, stop
        }

        var query = $.trim(input.val());
        var exact_match = 0;

        if (query.length > 0) {

            //Update text in "Create X" button.
            btnNewVendor.find('ins').text('Create "' + query + '"');

            listItems.each(function () {

                var elem = $(this);
                var text = String(elem.data('text'));
                //var partial_match = ( text.toLowerCase().indexOf( query.toLowerCase() ) > -1 );  //slightly faster
                var partial_match = text.toLowerCase().includes(query.toLowerCase()); //slightly more legible

                if (partial_match) {

                    // Highlight query in the text with <b>s
                    var textStart = text.toLowerCase().indexOf(query.toLowerCase());
                    var textEnd = textStart + query.length;
                    var htmlR = text.substring(0, textStart) + '<b>' + text.substring(textStart, textEnd) + '</b>' + text.substring(textEnd + length);
                    elem.find('ins').html(htmlR);

                    // Show this dropdown-item
                    elem.show();
                    dropdown.addClass('open');

                    // Check if any dropdown-item is exact match
                    if (query.length == text.length) {
                        exact_match += 1;
                    }

                } else {

                    // If no match to query
                    btnNewVendor.show(); //show "Create X" button 
                    radios.filter('[value=0]').prop('checked', true); //set radio val to zero
                    elem.hide(); //hide this dropdown-item
                }

            });

            if (exact_match) {
                btnNewVendor.hide();
            } else {
                btnNewVendor.show()
            }

        } else {
            //if no query, reset list
            listItems.hide();
            btnNewVendor.hide();
            dropdown.removeClass('open');
        }


    });

    inputVendor.on("blur", function () {
        var input = $(this);
        var dropdown = input.closest('.dropdown');
        var listItems = dropdown.find('.listItem');
        var query = $.trim(input.val());

        if (query.length > 0) {

            listItems.each(function () {

                var elem = $(this);
                var text = String(elem.data('text'));
                var has_match = (text.toLowerCase().indexOf(query.toLowerCase()) > -1) ? true : false;

                // If exact match, choose matching radio even without click 
                if (has_match && query.length == text.length) {
                    $(this).find('input').attr('checked', true);
                }

            });

        }

    });

    $(document).on("mouseup", ".listItem", function () {
        var txt = $(this).data('text');
        inputVendor.val(txt);
        dropdownVendors.closest('.dropdown').removeClass('open');
    });


    $(document).on('input', "#inputExpense", function (e) {
        //only positive numbers
        var elem = $(this);
        var str = elem.val().replace(/[^0-9.]/g, '').replace(/\.{2,}/g, '.');
        var first, last;
        while ((first = str.indexOf(".")) !== (last = str.lastIndexOf("."))) {
            str = str.substring(0, last) + str.substring(last + 1);
        }
        elem.val(str);
    });

    $(document).on('blur', "#inputExpense", function (e) {
        var elem = $(this);
        var v = Number(elem.val());
        elem.val(Math.abs(v).toFixed(2));
    });


    btnNewVendor.mouseup(async function () {
        var btn = $(this);
        btn.closest('.dropdown').removeClass('open');
        btn.hide();
        if (dropdownVendors.find('.dropdown-item').length > 1) {
            btnShowVendors.show()
        }

        const newVendorResponse = await createVendor(inputVendor.val());

        // if vendor created in backend, update the dropdown with received id of the created vendor 
        // and set is as selected 
        if (!newVendorResponse) {
            return;
        }

        btnSaveExpense.addClass('btn-spinner');
        const updatedVendorsList = await getVendors()
        btnSaveExpense.removeClass('btn-spinner');

        buildList(updatedVendorsList); //rebuild list with item added.

        $(`input[name='choose_vendor'][value=${newVendorResponse}]`).prop('checked', true);

    });

    btnShowVendors.mouseup(function () {
        var dropdown = $(this).closest('.dropdown');
        var listItems = dropdown.find('.listItem');
        listItems.each(function () {
            $(this).show();
        });
        dropdown.toggleClass('open');
    });


    $('#btnAttachExpense').mouseup(async function () {
        modalClosedBySubmit = true;
        var btn = $(this);
        var ven = $("input[name='choose_vendor']:checked");
        var ven_text = inputVendor.val();
        var cat = $('#expenseCategory option:selected');
        var date = $('#expenseDate').val();
        var amount = inputExpense.val();
        var row = table.find('tr.active');

        //show inline help-block if a required value is absent
        var valid = validateExpenseModal();
        if (!valid) {
            return;
        }

        $(this).prop('disabled1 btn-outline-primary', true).addClass('btn-spinner');

        // send request to .expense.php to create new expense in db
        const saveExpenseRequest = {
            save: true,
            vendor: ven,// ? .[0] ? .value ? ? 0,
            new_vendor: ven_text,
            category: cat.val(),
            amount,
            paid: true,
            payment_date: date,
            bill_date: date,
            due_date: date,
            payment_source: 100000,
        };
        const expenseSaved = await $.ajax({
            url: '/app/invoices/expense-save',
            type: 'POST',
            cache: false,
            data: saveExpenseRequest,
            dataType: 'json',
        }).catch(error => {
            alert("An error occurred while saving. Please try again.");
        })

        $(this).prop('disabled1 btn-outline-primary', false).removeClass('btn-spinner');

        if (!expenseSaved.success) {
            showExpenseError(expenseSaved.error);
        }

        if (valid && expenseSaved.success) {
            row.find('.lineDescription').val(cat.text() + ' from ' + ven_text + ' on ' + date);
            row.find('.linePrice').val(amount);
            row.find('.lineTotal').val(amount);
            row.find('.lineQty').val('1.00');
            row.find('[name="expense_id[]"]').val(expenseSaved.expense.id);
            row.find('.growTextarea').each(growTextarea);
            modalExpense.modal('hide');
        }

        reCalculate();
    });


    function validateExpenseModal() {
        var errorcount = 0;

        //show inline error message if required value missing
        $('.required').each(function (index, value) {
            var box = $(this).closest('td').find('.error');
            if ($(this).val().length > 0) {
                box.hide();
            } else {
                box.show();
                errorcount += 1;
            }
        });

        if (errorcount == 0) {
            return true;
        } else {
            return false;
        }

    }
</script>
<script>
    preselectCustomer();
   // const defaultItemsList = JSON.parse(`{"":"","Service":"Service","Hours":"Hours","Days":"Days","Product":"Product","Expense":"Expense","Discount_aynax":"Discount"}`);

    const account_upgrade_url = '';

    //Responsive ranged dates

    const inputStart = $('#dateStart');
    const inputEnd = $('#dateEnd');
    const start = new Date(inputStart.val());
    const end = new Date(inputEnd.val());

    if (is_touch_device()) {

        //If on mobile, use the native datepicker. Add class='touch' & set dates to ISO.
        $('.dateRange').find('input').attr('type', 'date').attr("readonly", false).addClass('touch');
        inputStart.val(new Date(start).toISOString().substr(0, 10));
        inputEnd.val(new Date(end).toISOString().substr(0, 10));

    } else {

        $('.dateRange').datepicker({
            maxViewMode: 'years',
            todayHighlight: false,
            format: "mm/dd/yyyy",
            autoclose: true
        });

    }

    $('#dateStart.touch').on('change', function () {
        var start = new Date(inputStart.val());
        var end = new Date(inputEnd.val());
        if (start > end) {
            inputEnd.val(new Date(start).toISOString().substr(0, 10));
        }
    });

    $('#dateEnd.touch').on('change', function () {
        var start = new Date(inputStart.val());
        var end = new Date(inputEnd.val());
        if (start > end) {
            inputStart.val(new Date(end).toISOString().substr(0, 10));
        }
    });

    function dateFormatUS(d) {
        var d = new Intl.DateTimeFormat("en-US", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit"
        }).format(d);
        return d;
    }

    function correctEmptyDates() {

        const start = new Date(inputStart.val());
        const end = new Date(inputEnd.val());
        const today = dateFormatUS(new Date());

        if (is_touch_device()) {
            //No empty dates (mobile):  Insert dates using toISOString
            if (isNaN(start) && isNaN(end)) {
                inputStart.val(today);
                inputEnd.val(today);
            } else if (!isNaN(start) && isNaN(end)) {
                inputEnd.val(new Date(start).toISOString().substr(0, 10));
            } else if (isNaN(start) && !isNaN(end)) {
                inputStart.val(new Date(end).toISOString().substr(0, 10));
            }

        } else {
            //No empty dates:  Insert dates using dateFormatUS
            if (isNaN(start) && isNaN(end)) {
                inputStart.val(today);
                inputEnd.val(today);
            } else if (!isNaN(start) && isNaN(end)) {
                inputEnd.val(dateFormatUS(start));
            } else if (isNaN(start) && !isNaN(end)) {
                inputStart.val(dateFormatUS(end));
            }
        }

    }

    // Use blur because datepicker().on('hide') would create 2nd datepicker visible on Android
    $(document).on('blur', "#dateStart, #dateEnd", function () {
        correctEmptyDates();
    });
</script>

<script type="text/javascript">
    window.NREUM || (NREUM = {});
    NREUM.info = {
        "beacon": "bam.nr-data.net",
        "licenseKey": "8a693f45cd",
        "applicationID": "1476015779",
        "transactionName": "YlYBYEFZWhBXUkBbWVscNkZaF0YMQ0VRQBhFWxM=",
        "queueTime": 0,
        "applicationTime": 63,
        "atts": "ThECFglDSR4=",
        "errorBeacon": "bam.nr-data.net",
        "agent": ""
    }
</script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const myParam = urlParams.get('id');
    if (myParam)
        loadInvoiceData(myParam)
</script>


<script>

const defaultItemsList = JSON.parse(`{"":"","Service":"Service","Hours":"Hours","Days":"Days","Product":"Product","Expense":"Expense","Discount_aynax":"Discount"}`);

// Add row

function addRow() {

$('.hasAutocomplete').unbind();

table.find('.taxDropdown').hide();
table.find('.focus').removeClass('focus');

//Clone row and attached functions
var lastRow = table.find('.line').last();
var newRow = lastRow.clone(true, false);

//Reset all values except tax
newRow.find('input.linePrice, input.lineQty, textarea, select, input.hasAutocomplete').val('');

// Set default item list for selection; prevent multiple instances of Prodcut being added via Inventory
// Skip if pub
if (typeof defaultItemsList !== 'undefined') {
    loadDefaultItemCategories(newRow)
}

newRow.find('.growTextarea').css('height', 'auto');
newRow.find('[name="expense_id[]"]').val('0');
newRow.find('.clearOnNew').val('');
newRow.find('.lineTotal').val('0.00');
newRow.find('.openTaxDropdown').prop('disabled', false)
newRow.find('.focus').removeClass('focus');
newRow.removeClass('isDiscount isExpense isInventory onlyPositive');
newRow.find('.hidden-inputs').remove(); //remove any attached expenses (see modal)
newRow.insertAfter(lastRow);

if ($('.zap').length > 1) {
    $('.zap').find('.btnDeleteRow').show();
}

$('.hasAutocomplete').each(createAuto);  //unbind then reattach, so it understands itself as separate
$('.growTextarea').each(growTextarea);

}


function collectInvoiceData() {
// Basic invoice information
const invoiceData = {
    from: {
        name: $('#from_name').val(),
        address: $('#from_address').val()
    },
    to: {
        id: $('#to_name').val(),
        name: $('#to_name option:selected').text(),
        address: $('#to_address').val()
    },
    logo: $('#customization_logoFilename').val(),
    heading: $('#doc_heading').val(),
    invoice_number: $('#doc_number').val(),
    po_number: $('#po_number').val(),
    invoice_date: $('#dateStart').val(),
    due_date: $('#dateEnd').val(),
    items: [],
    notes: $('#doc_notes').val(),
    subtotal: parseFloat($('#sum_subtotal').val().replace('$', '') || 0),
    total: parseFloat($('#sum_total').val().replace('$', '') || 0),
    amount_paid: parseFloat($('#amount_paid').val().replace('$', '') || 0),
    balance_due: parseFloat($('#balance_due').val().replace(/[^0-9.-]+/g, '') || 0)
};

// Collect line items
$('#dataTable tr.line').each(function() {
    const row = $(this);
    const item = {
        type: row.find('select[name="item[]"]').val(),
        description: row.find('textarea[name="description[]"]').val(),
        unit_price: parseFloat(row.find('input[name="unit_price[]"]').val() || 0),
        quantity: parseFloat(row.find('input[name="qty[]"]').val() || 0),
        tax_rate: row.find('.jtaxTotal').text().trim(),
        tax_amount: parseFloat(row.find('input[name="tax_total[]"]').val() || 0),
        amount: parseFloat(row.find('input[name="total[]"]').val() || 0),
        expense_id: row.find('input[name="expense_id[]"]').val()
    };
    
    invoiceData.items.push(item);
});

return invoiceData;
}

function submitInvoiceToWordPress() {
debugger;
// Collect the data
const invoiceData = collectInvoiceData();

// Prepare the AJAX request
$.ajax({
    url: 'http://localhost/wordpress1/wp-json/reetech-group/v1/invoices', // Replace with your actual endpoint
    type: 'POST',
    data: JSON.stringify(invoiceData),
    contentType: 'application/json',
    contentType: 'application/json',
    beforeSend: function(xhr) {
        // Add WordPress nonce for security if needed
       let i=0
      //  xhr.setRequestHeader('X-WP-Nonce', wpApiSettings.nonce);
    },
    success: function(response) {
        console.log('Invoice submitted successfully:', response);
        alert('Invoice saved successfully!');
    },
    error: function(xhr, status, error) {
        console.error('Error submitting invoice:', error);
        alert('Error saving invoice: ' + error);
    }
});
}

function loadInvoiceData(invoiceId) {
// Get nonce for API authentication
// const nonce = wpApiSettings.nonce; // Make sure to localize script with wp_localize_script()

$.ajax({
    url: `http://localhost/wordpress1/wp-json/reetech-group/v1/get-invoice/?id=${invoiceId}`,
    method: 'GET',
    headers: {
       // 'X-WP-Nonce': nonce
    },
    success: function(response) {
        // Populate main fields
        $('#from_name').val(response.from.name);
        $('#from_address').val(response.from.address);
        $('#to_name').val(response.to.id).trigger('change');
        $('#doc_number').val(response.invoice_number);
        $('#dateStart').val(response.invoice_date);
        $('#dateEnd').val(response.due_date);
        $('#doc_notes').val(response.notes);
        
        // Clear existing items
        $('#dataTable tr.line').not(':first').remove();
        
        // Populate line items
        response.items.forEach((item, index) => {
            // Add new row if not first item
            if(index > 0) {
                addRow();
               // addNewRow();
            }
            
            // Get current row
            const row = $('#dataTable tr.line').eq(index);
            
            // Populate fields
            row.find('select[name="item[]"]').val(item.item);
            row.find('textarea[name="description[]"]').val(item.description);
            row.find('input[name="unit_price[]"]').val(item.unit_price.toFixed(2));
            row.find('input[name="qty[]"]').val(item.quantity);
            row.find('.jtaxTotal').text(item.tax_rate);
            row.find('input[name="total[]"]').val(item.amount.toFixed(2));
        });
        
        // Update totals
        updateTotals();
    },
    error: function(xhr) {
        console.error('Error loading invoice:', xhr.responseJSON);
        alert('Failed to load invoice: ' + xhr.responseJSON.message);
    }
});
}

// Usage example - call this when you want to load an invoice
// loadInvoiceData(123); // Where 123 is the invoice ID




//GLOBAL
var table = $('#dataTable');

function is_touch_device() {
var prefixes = ' -webkit- -moz- -o- -ms- '.split(' ');
var mq = function (query) {
    return window.matchMedia(query).matches;
}
if (('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch) {
    return true;
}
var query = ['(', prefixes.join('touch-enabled),('), 'heartz', ')'].join('');
return mq(query);
}

function onlyNumbersLettersOrDashes(obj) {
var regex = new RegExp("[^a-zA-Z0-9-]");
if (obj.value.search(regex) != -1) {
    obj.value = obj.value.replace(regex, '');
    alert('Only letters, numbers and dashes allowed in this field.');
}
}

function sanitizeNames(obj) {

var regex = new RegExp("[^" + "a-z" + decodeURI("\\u00C0-\\u017F") + "0-9_.,' ()&-]", "i");

if (obj.value.search(regex) != -1) {
    var match = obj.value.match(regex);
    if (match == " ") var space = "Empty space"; else var space = "";
    obj.value = obj.value.replace(regex, '');
    alert('Illegal Character Removed: ' + match + space + "\n\nAllowed Input:\n------------------\nletters\nnumbers: 0-9\nempty space\nparentheses: ( )\nunderscore: _\nperiod: .\ncomma: ,\napostrophe: \'\nampersand: &\nhyphen: -");
}
}


//Textarea
function growTextarea(i, elem) {
var elem = $(elem);
var resizeTextarea = function (elem) {
    var scrollLeft = window.pageXOffset || (document.documentElement || document.body.parentNode || document.body).scrollLeft;
    var scrollTop = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop;
    elem.css('height', 'auto').css('height', elem.prop('scrollHeight'));
    window.scrollTo(scrollLeft, scrollTop);
};

elem.on('input', function () {
    resizeTextarea($(this));
});

resizeTextarea($(elem));
}



//MODULE functions
const preselectCustomer1 = () => {
// Check if the URL contains the "&customer=16" parameter
const urlParams = new URLSearchParams(location.search);
for (const [key, value] of urlParams) {
    if (key === 'customer') {
        const customerSelectBox = document.getElementById('to_name');

        // Loop through the available customers select box
        for (let i = 0; i < customerSelectBox.options.length; i++) {
            if (customerSelectBox.options[i].value === value) {
                // Set the selected attribute to 'true' for the matching customer id
                customerSelectBox.options[i].selected = true;
                customerSelectBox.dispatchEvent(new Event("change"));
            }
        }
    }
}
}


function getCustomerAddress(customerId) {

// means 'New Customer' is selected 
if (customerId == 0) {

    document.getElementById('rowNewCustomer').style.display = '';
    document.getElementById('to_new_customer').value = '';
    document.getElementById('to_address').value = '';

}

// means existing customer is selected and an address must be fetched and inserted 
else {

    document.getElementById('rowNewCustomer').style.display = 'none';

    ajax_get("/getCustomerAddress.inc.php?customer=" + customerId, function () {

        //alert(xmlhttp.responseText); 

        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

            // get the whole address record 
            var node = xmlhttp.responseXML.documentElement.getElementsByTagName("address");

            // to_address
            var to_address = node[0].getElementsByTagName("to_address")[0];

            if (to_address.hasChildNodes()) var address = to_address.firstChild.nodeValue; else var address = '';

            document.getElementById("to_address").innerHTML = address;
            $('#to_address').each(growTextarea);

            //if there are two empty '.line', preselect previous tax: 
            if (table.find('.line').length == 2 && $('.lineTotal:eq(0)').val() == "0.00" && $('.lineTotal:eq(1)').val() == "0.00") {

                //Retrieve previous tax-id's for this customer: 
                var node = xmlhttp.responseXML.documentElement.getElementsByTagName("taxes");

                var taxes = node[0].getElementsByTagName("tax_id")[0];
                if (taxes.hasChildNodes()) { if (taxes.firstChild.nodeValue > 0) var tax_id = taxes.firstChild.nodeValue?.trim(); else var tax_id = '' };
                taxes = node[0].getElementsByTagName("tax2_id")[0];
                if (taxes.hasChildNodes()) { if (taxes.firstChild.nodeValue > 0) var tax2_id = taxes.firstChild.nodeValue?.trim(); else var tax2_id = '' };
                taxes = node[0].getElementsByTagName("tax3_id")[0];
                if (taxes.hasChildNodes()) { if (taxes.firstChild.nodeValue > 0) var tax3_id = taxes.firstChild.nodeValue?.trim(); else var tax3_id = '' };

                //Clear all taxes selected: 
                $.each($('.NoTax'), function (i, obj) {

                    $(obj).prop("checked", true);
                    changeTaxSelect(obj);

                });

                //Update taxes: 
                if (tax_id > 0 || tax2_id > 0 || tax3_id > 0) {

                    //Select the tax-lines to be checked: 
                    //ul[data-group='Companies']
                    tax_lines = $('.SingleTax[data-component_id="' + tax_id + '"], .SingleTax[data-component_id="' + tax2_id + '"], .SingleTax[data-component_id="' + tax3_id + '"]');

                    //Update each tax line with the customer preselected tax: 
                    $.each(tax_lines, function (i, obj) {

                        $(obj).prop("checked", true);
                        changeTaxSelect(obj);

                    });

                }

            }

        }
    });


}
}

function numberToCurrency(num) {
//Outputs a string for use in locations that need a default 0.00 value.
if (num) {
    return (Number(num).toFixed(2));
} else {
    return ('0.00');
}
}

function numberFormat(value, precision = 2) {
value = parseFloat(value); // make sure we deal with type Number

if (isNaN(value) || value === null || value === undefined) {
    return 0.00;
}
// get the rounding scale from provided precision. 
const rounding_scale = Math.pow(10, precision);
// Rounding scale is used to multiply and divide the provided value by, so that in between we can work with int (whole number). 
// add the smallest representable number (epsilon) to make sure we round up
const roundedValue =  Math.round((value * rounding_scale) * (1 + Number.EPSILON)) / rounding_scale;
return roundedValue.toFixed(precision);
}

// adds provided values treating them as of type Number
function sum(...values) {
return values.reduce((accumulator, currentValue) => {
    const num = isNaN(currentValue) ? 0.00 : Number(currentValue);
    return accumulator + num;
}, 0);
}

// Row Sums
function calculateLineTotal(elem) {
var elem = $(elem);
var row = elem.closest('.line');
var qty = row.find('.lineQty').val() || 0;
var cost = row.find('.linePrice').val() || 0;
var linetotal = (Number(qty) * Number(cost)) || 0;
row.find('.lineTotal').val(numberToCurrency(linetotal));
}


function reCalculate() {

//Calculate total discount
var total_discount = 0;
table.find('.isDiscount').find('.lineTotal').each(function () {
    total_discount += Math.abs(Number($(this).val()));
});

//Display discounts
$('#sum_discount').val(numberToCurrency(total_discount));
(total_discount > 0 ? $('#sum_discountTR').show() : $('#sum_discountTR').hide());

//Calculate subtotal
var subtotal = 0;
table.find('.line').not('.isDiscount').find('.lineTotal').each(function () {
    subtotal += Number($(this).val());
});
$('#sum_subtotal').val(numberToCurrency(subtotal));

var amount_paid = Number($('#amount_paid').val());
var new_sum_tax = 0;

//Calculate tax if checked
if ($('#customization_tax').is(':checked')) new_sum_tax = reCalculateTax();

var sum_total = sum(subtotal, new_sum_tax, -total_discount);
var balance_due = sum_total - amount_paid;

//Write back into the form
$('#sum_total').val(numberFormat(sum_total, 2));
$('#balance_due').val('$' + numberFormat(balance_due, 2))

if ($('body').hasClass('pub')) {
    $('#insert_balance').text(currencyCode + numberToCurrency(balance_due));
}

}


function reCalculateTax() {

var rowCount = table.find('.line').length;
var discount = $('#sum_discount').val() || 0;

var sum_of_all_taxes = 0;
var subtotal_positive_lines = 0;

//Discount should only be distributed on positive lines:
for (rowNo = 0; rowNo < rowCount; rowNo++) {

    var row = table.find('.line').eq(rowNo);
    var p = Number(row.find('.linePrice').val()) || 0;
    var q = Number(row.find('.lineQty').val()) || 0;
    var rowAmount = numberFormat(p * q, 2);
    if (rowAmount > 0) subtotal_positive_lines = sum(subtotal_positive_lines, rowAmount);

}
if (subtotal_positive_lines > 0) var discount_per_subtotal = discount / subtotal_positive_lines; else var discount_per_subtotal = 0;


var taxPct = [];
var taxSums = [];
var taxComponentName = [];
var taxComponentNameValue;


table.find('.line').each(function () {

    lineTotal = numberFormat($(this).find('.lineTotal').val() || '0', 2);
    var cell = $(this).find('.tax1');

    for (i = 1; i < 4; i++) {

        var taxPctValue = Number(cell.find('input').eq(i).val());

        if (taxPctValue > 0) { //both the tax percentage and the line amount must be over 0 

            var new_value = '';
            var taxComponentId = cell.find('input').eq(i + 3).val();
            var taxComponentNameValue = cell.find('.SingleTax[data-component_id=' + taxComponentId + ']').data("name");

            for (j = 0; j < taxPct.length; j++) {

                if (taxPctValue.toFixed(4) == (taxPct[j] * 1).toFixed(4) && taxComponentNameValue == taxComponentName[j]) new_value = j;

            }

            // calculate the tax per line after subtracting the discount proportionally 
            if (new_value === "") {

                taxPct.push(Math.round(taxPctValue * 1e4) / 1e4);
                taxComponentName.push(taxComponentNameValue);
                var line_total_after_discount = (lineTotal < 0) ? lineTotal : lineTotal - (lineTotal * discount_per_subtotal);
                const line_tax = line_total_after_discount * taxPctValue / 100;
                taxSums.push(line_tax);

            } else {

                // this line uses a tax percentage already in the array; update the tax sums for that tax percentage 
                var old_tax = taxSums[new_value];
                var line_total_after_discount = (lineTotal < 0) ? lineTotal : lineTotal - (lineTotal * discount_per_subtotal);
                const line_tax = line_total_after_discount * taxPctValue / 100;
                taxSums.splice(new_value, 1, sum(line_tax, old_tax));

            }

        }

    }

});  // end each

// Sort the two arrays 
if (taxPct.length > 1) {

    var tempPct = [];
    var tempSums = [];
    var tempName = [];
    var taxPctLength = taxPct.length;

    for (i = 0; i < taxPctLength; i++) {

        for (x = 0; x < taxPct.length; x++) { //runs through the array and finds the highest value

            taxPct[x] = taxPct[x] * 1; //multiplies with 1 to cast the value as a number to get numerical instead of alphabetical comparison		 		

            if (x == 0) {
                highestValue = taxPct[0];
                highestPos = 0;
            }

            if (taxPct[x] > highestValue) {
                highestValue = taxPct[x];
                highestPos = x;
            }
        }

        tempPct.push(highestValue); //puts the highest value found in a new temp array
        taxPct.splice(highestPos, 1); //removes the value placed in the temp array from the original array
        tempTax = numberFormat(taxSums[highestPos], 2);
        tempSums.push(tempTax);
        sum_of_all_taxes = sum(sum_of_all_taxes, tempTax);
        taxSums.splice(highestPos, 1);
        tempName.push(taxComponentName[highestPos]);
        taxComponentName.splice(highestPos, 1);
    }

    taxPct = tempPct;
    taxSums = tempSums;
    taxComponentName = tempName;
}

else {

    if (taxSums[0] * 1 > 0) {
        sum_of_all_taxes = numberFormat(taxSums[0], 2);
    }
}


var tableTaxes = $('#tableTaxes'); //table for inserting the tax sums
var taxSum_rows = tableTaxes.find("input[name='line_tax[]']").length;

// remove all current tax rows 
if (taxSum_rows > 0) {
    tableTaxes.find('tr').remove();
}

if (taxPct.length > 0) {

    for (i = 0; i < taxPct.length; i++) {

        var taxName = taxComponentName[i];
        var taxPctOutput = pad_zeros(taxPct[i] * 1);
        var taxSumsOutput = numberFormat(taxSums[i], 2);

        var html = '<tr><td class="sum-label">+ ' + taxName + ' (' + taxPctOutput + '%)</td>' +
            '<td class="sum-number"><input type="text" name="line_tax[]" value="' + taxSumsOutput + '" readonly></td></tr>';

        tableTaxes.append(html);

    }
}

return sum_of_all_taxes;
}


//delete row
table.on('click', '.btnDeleteRow', function (e) {
var rowCount = table.find('.zap').length;

if (rowCount > 1) {
    $(this).closest('.line').remove();
}
rowCount--;

if (rowCount <= 1) {
    $(document).find('.btnDeleteRow').hide();
}
reCalculate();
});

const loadDefaultItemCategories = (row) => {
const selectBox = row.find('[name="item[]"]');
selectBox.html('');
Object.keys(defaultItemsList).map(category => {
    const option = $("<option>").val(category).text(defaultItemsList[category]);
    selectBox.append(option);
});
}



function toggleLogo() {

var isChecked = $('#customization_logo').is(':checked');
var imageName = $('#customization_logoFilename').val();
if (imageName) var hasImage = (imageName.length > 0);

if (isChecked) {

    if (hasImage) {

        //Show image & delete-button
        $('#btnDeleteLogo').show();
        $('#upload_area').removeClass('empty').show();
        $('#upload_area').find('img').attr('src', baseHref + imageName).show();

    } else {

        //Show upload container
        $('#btnUploadLogo').show();
        $('#btnDeleteLogo').hide();
        $('#upload_area').addClass('empty').addClass('focus').addClass('yournamehere').show();
        $('#upload_area').find('img').attr('src', '').hide();

    }

    $('#modeEdit').addClass("logoShown");

} else {

    //Remove logo container
    $('#upload_area').hide();
    $('#btnUploadLogo').hide();
    $('#btnDeleteLogo').hide();
    $('#customization_logoFilename').val('');
    $('#modeEdit').removeClass("logoShown");

}

}

function updateLogo() {
// #customization_logoFilename onchange event fired from ajaxuploader.php when image successfully uploads 
$('#upload_area').find('img').attr('src', baseHref + $('#customization_logoFilename').val()).show();
$('#btnUploadLogo').hide();
$('#btnDeleteLogo').show();
$('#upload_area').show().removeClass('empty').removeClass('focus').removeClass('yournamehere').removeClass('uploading');
}

function deleteLogo() {
$('#customization_logoFilename').val('');
$('#upload_area').addClass('empty').addClass('yournamehere');
$('#upload_area').find('img').attr('src', '').hide();
$('#btnDeleteLogo').hide();
$('#btnUploadLogo').show();
}


function pad_zeros(value) {

//Stop if no value exists
if (!Math.abs(value) > 0) return;

//Set everything to at least two decimals; remove 3+ zero decimals, keep non-zero decimals
var new_value = value * 1; //removes trailing zeros
new_value = new_value + ''; //casts it to string
pos = new_value.indexOf('.');

if (pos == -1) new_value = new_value + '.00';
else {

    var integer = new_value.substring(0, pos);
    var decimals = new_value.substring(pos + 1);
    while (decimals.length < 2) decimals = decimals + '0';
    new_value = integer + '.' + decimals;
}

return new_value;
}


function correctInputValue(obj) {

var elem = $(obj);
var row = elem.closest('.line');
var v = Number(elem.val());

//Stop if no value exists
if (!Math.abs(v) > 0) return;

if (row.hasClass('isDiscount')) {

    //In discount rows, unit price is negative
    if (elem.hasClass('linePrice')) elem.val(pad_zeros(-1 * Math.abs(v)));
    //In discount rows, qty is positive
    if (elem.hasClass('lineQty')) elem.val(pad_zeros(Math.abs(v)));

} else if (row.hasClass('isExpense') || row.hasClass('onlyPositive')) {

    //In expense rows, all values should be positive
    elem.val(pad_zeros(Math.abs(v)));

}

}

function ajax_get(url, passedFunction) {

if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp = new XMLHttpRequest();
} else {
    // code for IE6, IE5
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
}

xmlhttp.onreadystatechange = passedFunction;
xmlhttp.open("GET", url, true);
xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
xmlhttp.send(null);
}

table.on('change', 'select.selectItem', function (e) {

//reset active (selected) line
$('.line').removeClass('active');

var self = $(this);
var row = self.closest('.line');
var selectedOption = self.find(":selected").val();
var taxButton = row.find('.openTaxDropdown');

if ($.inArray(selectedOption, ['Discount', 'Expense', 'Discount_aynax', 'Payment_aynax']) >= 0) {
    var isDisabled = true;
}

if (isDisabled) {

    //Set tax to No tax
    NoTaxSelector = row.find(".taxDropdown").find("input").first();
    NoTaxSelector.click(); //NOTE: Clicks the 'No Tax' checkbox. This will run reCalculate and remove any tax from the totals.
    NoTaxSelector.prop("checked", true);
    taxButton.prop('disabled', true);

} else {

    taxButton.prop('disabled', false);

}


var p = Math.abs(Number(row.find('.linePrice').val()));
var q = Math.abs(Number(row.find('.lineQty').val()));

if (selectedOption == 'Discount_aynax') {

    row.addClass('isDiscount');

    // if price is not null or zero, make it negative number
    if (p > 0) row.find('.linePrice').val(pad_zeros(-1 * p));

    // if qty is not null or zero, make it positive number
    if (q > 0) row.find('.lineQty').val(pad_zeros(q));

    // Display discount in sums at bottom of page
    $('#sum_discountTR').show();

} else {
    row.removeClass('isDiscount');
    if (p > 0) row.find('.linePrice').val(pad_zeros(p));
    if (q > 0) row.find('.lineQty').val(pad_zeros(q));
}

if (selectedOption == 'Expense') {

    if (self.hasClass('permEx')) {
        row.addClass('active');
        row.addClass('isExpense');
        $('#modalAttachExpense').modal('show');
    } else {
        //for employee
        row.addClass('active');
        row.addClass('onlyPositive');
    }

    //Prevent negative values in Expense 
    // if price is not null or zero, make it positive number
    if (p > 0) row.find('.linePrice').val(pad_zeros(p));

    // if qty is not null or zero, make it positive number
    if (q > 0) row.find('.lineQty').val(pad_zeros(q));

}

calculateLineTotal($(this));
reCalculate();

});


function newLineClick() {

addRow();
var taxButton = table.find('.line:last-child').find('.openTaxDropdown');
taxButton.prop('disabled', false);

}


function updateQueryString(key, value, url) {
if (!url) url = window.location.href;
var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
    hash;

if (re.test(url)) {
    if (typeof value !== 'undefined' && value !== null)
        return url.replace(re, '$1' + key + "=" + value + '$2$3');
    else {
        hash = url.split('#');
        url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
        if (typeof hash[1] !== 'undefined' && hash[1] !== null)
            url += '#' + hash[1];
        return url;
    }
}
else {
    if (typeof value !== 'undefined' && value !== null) {
        var separator = url.indexOf('?') !== -1 ? '&' : '?';
        hash = url.split('#');
        url = hash[0] + separator + key + '=' + value;
        if (typeof hash[1] !== 'undefined' && hash[1] !== null)
            url += '#' + hash[1];
        return url;
    }
    else
        return url;
}
}

function createDateQuery(date) {
var date = date;
var month = (date.getMonth() + 1) < 10 ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
var day = (date.getDate()) < 10 ? '0' + (date.getDate()) : (date.getDate());
var datestring = encodeURIComponent(month + '/' + day + '/' + date.getFullYear());
return datestring;
}


//Autocomplete
var visible;

function createAuto(i, elem) {

var input = $(elem);
var dropdown = input.closest('.dropdown');
var listItems = dropdown.find('.dropdown-radio');

listItems.hide();
listItems.each(function () {
    $(this).data('value', $(this).text());
    //!important, keep this copy of the text outside of keyup/input function
});

input.on("input", function (e) {

    var query = input.val().toLowerCase();
    if (query.length > 1) {

        dropdown.addClass('open').addClass('in');

        listItems.each(function () {

            var text = $(this).data('value');
            if (text.toLowerCase().indexOf(query) > -1) {

                var textStart = text.toLowerCase().indexOf(query);
                var textEnd = textStart + query.length;
                var htmlR = text.substring(0, textStart) + '<strong>' + text.substring(textStart, textEnd) + '</strong>' + text.substring(textEnd + length);
                $(this).find('ins').html(htmlR);
                $(this).show();

            } else {

                $(this).hide();

            }
        });

        visible = listItems.filter(':visible');

    } else {
        listItems.hide();
        dropdown.removeClass('open').removeClass('in');
    }
});



input.on("keyup", function (e) {
    switch (e.keyCode) {
        case 13: //enter
            dropdown.removeClass('open').removeClass('in');
            break;
        case 40: //down arrow
            visible.eq(0).focus();
            break;
        default:
            return;
    }

});

listItems.on("keyup", function (e) {

    var li = $(this);

    if (visible.length > 0) {

        switch (e.keyCode) {
            case 13: //enter
                li.trigger('click');
            case 38: //up arrow
                li.prevAll(':visible').first().focus();
                break;
            case 40: //down arrow
                li.nextAll(':visible').first().focus();
                break;
            default:
                return;
        }
    }

});

//prevent page to scroll when scrolling the pricelist
listItems.on("keydown", function(e){
  if (e.keyCode === 38 || e.keyCode === 40) e.preventDefault();
});

listItems.on('click', function (e) {

    var elem = $(this);
    var row = elem.closest('.line');

    row.find('.usedOnlyForArrowKeysToFocus').prop('checked', false);

    var txt = elem.text().replace(/^\s+|\s+$/g, "");  //remove leading and trailing whitespace
    input.val(txt);
    dropdown.removeClass('open').removeClass('in');

    var itemtype = elem.data('itemtype');
    row.find("select.selectItem").val(itemtype);

    var price = elem.data('price');
    row.find(".linePrice").val(price);
    calculateLineTotal(elem);

    var tax1 = elem.data('tax1');
    if (Number(tax1) > 0) {

        if (!$('#customization_tax').is(':checked')) {
            $('#customization_tax').prop('checked', true).trigger("change");
        }

        row.find('.taxDropdown').find('input[type="checkbox"]').prop("checked", false);
        row.find('.openTaxDropdown').removeClass('placeholder');

        //check first tax
        var cb1 = row.find(".SingleTax[data-component_id='" + elem.data('taxid1') + "']");
        cb1.prop('checked', true);
        updateTax(cb1);

        //check second tax
        var tax2 = elem.data('tax2');
        var cb2 = row.find(".SingleTax[data-component_id='" + elem.data('taxid2') + "']");
        if (Number(tax2) > 0) {
            cb2.prop('checked', true);
            updateTax(cb2);
        }

        //check third tax
        var tax3 = elem.data('tax3');
        var cb3 = row.find(".SingleTax[data-component_id='" + elem.data('taxid3') + "']");
        if (Number(tax3) > 0) {
            cb3.prop('checked', true);
            updateTax(cb3);
        }

    }
    reCalculate();
    reCalculateTax();


});

}


// jQuery(document).ready(function($) {


//     wpApiRequest(
//         'GET',
//         'http://localhost/wordpress1/wp-json/items/v1/all',
//         {},
//         {showSpinner: true},
//         successGetData
//     );

//     function successGetData(data){
//             const response =data; 
//             const mySelect = new CustomSelect('#mySelect', {
//                 placeholder: 'Choose item type',
//                 data: data.data,
//                 initialValue: 'Expense' // Optional default value
//             });
        
//             // Get selected value
//             mySelect.on('change', () => {
//                 console.log('Selected value:', mySelect.getValue());
//                 console.log('Selected text:', mySelect.getSelectedText());
//             });           
        
//             }    



// });
// FUNCTIONS ON PAGE LOAD //

(function ($) {


$('.hasAutocomplete').each(createAuto);


// Toggle options above the form
$('#btnToggleOptions').click(function () {
    $('#options').toggleClass('open');
    var buttontext = ($('#options').hasClass('open')) ? "Hide Customization Options" : "Show Customization Options";
    $(this).text(buttontext);
});


//Focus background
table.on('click', 'td', function (e) {
    $('.focus').not($(this)).removeClass('focus');
    $(this).addClass('focus');
    $(this).find('input,textarea,select').filter(':visible:first').focus();
});
table.on('focusin', 'td', function (e) {
    $('.focus').not($(this)).removeClass('focus');
    $(this).addClass('focus');
});


// Expand textareas as you type
$('.growTextarea').each(growTextarea);


//Datepickers

// Regular datepicker
$('.hasDatepicker').datepicker({
    todayHighlight: false,
    format: "mm/dd/yyyy",
    autoclose: true
});

// Ranged datepicker
$('.hasDaterange').datepicker({
    todayHighlight: false,
    format: "mm/dd/yyyy",
    autoclose: true
});

//Date range in the table filter app/__common/html/date_range.php
$('.hasDaterange .startDate').each(function () {
    $(this).on('changeDate', function (e) {

        var url = window.location.href;
        var datequery = createDateQuery(e.date);
        var endDate = encodeURIComponent($('.endDate').val());

        url = updateQueryString('from', datequery, url);
        url = updateQueryString('to', endDate, url);

        window.location = url;

    });
});

$('.hasDaterange .endDate').each(function () {
    $(this).on('changeDate', function (e) {

        var url = window.location.href;
        var datequery = createDateQuery(e.date);
        var startDate = encodeURIComponent($('.startDate').val());

        url = updateQueryString('from', startDate, url);
        url = updateQueryString('to', datequery, url);
        window.location = url;

    });
});

//Dropdown options in the table filter
$('.dateOption').click(function () {
    var today = new Date();

    var dd = today.getDate();
    var mm = today.getMonth();
    var yyyy = today.getFullYear();
    var quarterMonth = (Math.floor(mm / 3) * 3);

    var option = $(this).data("value");
    var url = window.location.href;
    var start;
    var end;

    if (option == "this_month") {
        start = new Date(yyyy, mm, 1);
        end = new Date(yyyy, mm + 1, 0);
    } else if (option == "last_month") {
        start = new Date(yyyy, mm - 1, 1);
        end = new Date(yyyy, mm, 0);
    } else if (option == "this_quarter") {
        start = new Date(yyyy, quarterMonth, 1);
        end = new Date(yyyy, quarterMonth + 3, 0);
    } else if (option == "last_quarter") {
        start = new Date(yyyy, quarterMonth - 3, 1);
        end = new Date(yyyy, quarterMonth, 0);
    } else if (option == "this_year") {
        start = new Date(yyyy, 0, 1);
        end = new Date(yyyy + 1, 0, 0);
    } else if (option == "last_year") {
        start = new Date(yyyy - 1, 0, 1);
        end = new Date(yyyy, 0, 0);
    } else {
        var parent = $(this).parents('.dropdown-menu');
        start = new Date(parent.data('mindate'));
        end = new Date(parent.data('maxdate'));
    }

    var startquery = createDateQuery(start);
    var endquery = createDateQuery(end);
    url = updateQueryString('from', startquery, url);
    url = updateQueryString('to', endquery, url);
    window.location = url;
});


//Filter Customer
$('.filterCustomer').click(function (page) {
    var customerID = $(this).data('value');
    var url = window.location.href;
    url = updateQueryString('customer', customerID, url);
    url = updateQueryString('p', '1', url);
    window.location = url;
});

$('.filterStatus').click(function (page) {
    var status = $(this).data('value');
    var url = window.location.href;
    url = updateQueryString('status', encodeURI(status), url);
    window.location = url;
});


//Update Filter
//run on page load, when URL has been updated
$('.filterDropdown').find(".dropdown-item").each(updateParentText);

//Update SelectBox
//run when page is not reloading
$('.selectDropdown').find(".dropdown-item").on("click", updateParentText);

function updateParentText(i, elem) {
    if (!$(elem).hasClass('active')) {
        return;
    } else {
        $(this).closest('.dropdown').find('ins').html($(this).text());
    }
}


//Print Button
$('.btnPrint').click(function () {
    if (isFormEdited()) {
        $('#modalSave').modal('show');
    } else if (typeof account_upgrade_url !== 'undefined' && !!account_upgrade_url) {
        const currentUrl = window.location.href;
        window.history.pushState({ }, '', '/app/invoices/print');
        window.location.href = account_upgrade_url;
        window.history.replaceState({ }, '', currentUrl);
    } else {
        window.print();
    }
});

//Dismissable alert
$(".alert .close").click(function (e) {
    $(this).closest('.alert').removeClass('show');
});


//Submit form button with spinner
$('.btnSubmit').click(function (e) {
    e.preventDefault();

    //disable submit button & add spinner
    $(this).prop('disabled', true).addClass('btn-spinner');
    $(this).closest('form').submit();

    //reenable button if form failed to submit the first time
    setTimeout(function () {
        $(this).prop('disabled', false).removeClass('btn-spinner');
    }, 6000);

});


//Toggle PO
$('#customization_poNumber').change(function () {

    if ($(this).is(':checked')) {
        $('#po_numberTR').show();
        $('#po_number').focus();
    } else {
        $('#po_numberTR').hide();
    }

});


//Toggle Tax
$('#customization_tax').change(function () {

    if ($(this).is(':checked')) {
        $('.taxItem').show();
        table.addClass('with-taxes');
    } else {
        $('.taxItem').hide();
        table.removeClass('with-taxes');
        $('#tableTaxes').find('tr').remove();
    }

    $('.NoTax').click().prop('checked', true); //simulated click causes yellow focus
    $('.taxItem').removeClass('focus'); //remove yellow focus

});


//Logo Input

$('#logo_file_input').click(function () {
    $(this).val('');  //Reset value of file input onClick so onChange event is always called after upload
});

$('#logo_file_input').change(function () {

    // checking for allowed file types before upload starts
    var ext = $('#logo_file_input').val().split('.').pop().toLowerCase();

    if ($.inArray(ext, ['bmp', 'gif', 'png', 'jpg', 'jpeg']) == -1) {

        // clearing div and creating the error message in the upload area
        $('#upload_area').removeClass();
        $('#upload_area').addClass('empty uploading');
        $('#upload_area').empty();
        $('#upload_area').append("<div class='error-uploading'><i class='xe033'></i><span> File type isn't allowed: " + ext + ".<br>Accepted types: jpg, jpeg, gif, bmp and png.</span></div>");

        // clearing input field containing the custom logo file path
        $('#logo_file_input').val(null);

        return;
    }

    $('#upload_area').removeClass('yournamehere').addClass('uploading');
    
    // function ajaxUpload(form,url_action,id_element,html_show_loading,html_error_http)
    ajaxUpload(this.form, '/ajaxuploader.php', 'upload_area', '<div class="is-uploading"><i class="spinner"></i><p>File Uploading Please Wait...</p></div>', '<div class="error-uploading"><i class="xe033"></i><span>There was an error; please try again.</span></div>'); return false;

});

toggleLogo();

//hide dropdown
table.on('focus', ".lineQty, .linePrice", function () {
    $('.dropdown').removeClass('open').removeClass('in');
});

//row sums
table.on('blur', ".lineQty, .linePrice", function () {
    correctInputValue($(this));
    calculateLineTotal($(this));
    reCalculate();
});


//TYPING

function numbersOnly(elem) {
    var elem = $(elem);
    // -? before 0-9 allows negative numbers
    var str = elem.val().replace(/[^-?0-9.]/g, '').replace(/\.{2,}/g, '.');
    var first, last;
    while ((first = str.indexOf(".")) !== (last = str.lastIndexOf("."))) {
        str = str.substring(0, last) + str.substring(last + 1);
    }
    elem.val(str);
}

//Numbers 

table.on('input', ".numbersOnly", function () {
    numbersOnly($(this));
});

$(document).on('blur', ".isCurrency", function () {
    var elem = $(this);
    var v = elem.val();
    if ($.isNumeric(v)) {
        elem.val(Number(v).toFixed(2));
    }
});

$(document).on('input', ".isCurrency", function () {
    numbersOnly($(this));
});

//Quantity
//const roundAccurately = (number, decimalPlaces) => Number(Math.round(number + "e" + decimalPlaces) + "e-" + decimalPlaces);
//$(this).val( roundAccurately( $(this).val(), 5 ) );  //Future: Qty shouldnt require .00

table.on('blur', ".lineQty, .linePrice", function () {
    var elem = $(this);
    var v = elem.val();
    if ($.isNumeric(v)) {
        elem.val(pad_zeros(v));
    }
});


//Expense 
table.on('blur', ".onlyPositive", function () {
    var elem = $(this);
    if ($.isNumeric(elem.val())) {
        elem.val(Math.abs(elem.val())).toFixed(2);
    }
});


//Typing only alphanumeric minus coding and non-ascii chars
$('.typeAlpha').on("input", function (e) {
    var pos = this.selectionStart;
    //remove anything that is not:  A-z, 0-9 and #@_.,'& ()-/"*
    const toBeReplaced = /[^A-Za-z\n\r0-9#@_.,\'& ()-\/"*]/g;
    var str = $(this).val().replace(toBeReplaced, '').replace(/\.{2,}/g, '.');
    var len = str.length;
    $(this).val(str);
    this.selectionEnd = pos - (len - str.length);
});


//up/down arrow keys
table.on('keyup', ".lineQty, .linePrice", function (e) {
    var code = e.keyCode || e.which;
    if (code == 38 || code == 40) {
        var row = $(this).closest('.line');
        var cell = $(this).closest('td').index();
        if (code == 38 && row.index() > 0) {
            //go up
            row.prev().find('td').eq(cell).find('input').focus();
        }
        if (code == 40) {
            //go down
            row.next().find('td').eq(cell).find('input').focus();
        }
    }
});


//Deactivate pdf-button for 3 sec. after being clicked
$(".btnPDF").on('click', function () {

    $(".btnPDF").addClass('btn-spinner');
    setTimeout(function () { $(".btnPDF").removeClass('btn-spinner'); }, 3000);

});


//Recalculate on page load to show tax sums
$("select.selectItem").each(function () {
    var elem = $(this);
    var row = elem.closest('.line');
    if (elem.val() == "Discount_aynax") row.addClass('isDiscount');
    if (elem.val() == "Expense") {
        if (elem.hasClass('permEx')) {
            row.addClass('isExpense');
        } else {
            row.addClass('onlyPositive');
        }
    }
    if (elem.val().includes("Inventory_aynax")) row.addClass('isInventory');
});

reCalculate();


//Document event listeners
$(document).on('click', function (e) {
    var origin = $(e.target);

    //Hide taxDropdown on click outside
    if (!origin.closest('.dropdown').length) {
        $('.taxDropdown').hide();
        $('.taxDropdown').closest('.focus').removeClass('focus');

        $('.dropdown').removeClass('open');
    }

    //Hide .focus on click outside
    var focus_parent = origin.closest('.focus');
    $('.focus').not(focus_parent).removeClass('focus');

});



//Submit form
var form = $('#invoice_form');
var formdata = null;
window.onload = function () {
    formdata = $.param($.map(form.serializeArray(), function (v, i) {
        return (v.name == "cf-turnstile-response" || v.name == "emailaddress" || v.name == "password") ? null : v;
    }));
};

form.submit(function () {
    window.onbeforeunload = null
})

window.onbeforeunload = function () {

    //serialize without login name or password (pub)
    var newdata = $.param($.map(form.serializeArray(), function (v, i) {
        return (v.name == "cf-turnstile-response" || v.name == "emailaddress" || v.name == "password") ? null : v;
    }));

    if (newdata != formdata) {
        return 'You have unsaved changes.'
    }

}

function isFormEdited() {
    var newdata = $.param($.map(form.serializeArray(), function (v, i) {
        return (v.name == "cf-turnstile-response" || v.name == "emailaddress" || v.name == "password") ? null : v;
    }));
    if (newdata != formdata) {
        return 'edited';
    }

}

$(".saveFirst").on('click', function (e) {
    var elem = $(this);
    if (isFormEdited()) {
        e.preventDefault();
        $('#modalSave').modal('show');
    } else {
        if (elem.attr('sel') == "btnPDF") { elem.addClass('btn-spinner') };
        window.location.replace(elem.attr('href'));
        setTimeout(function () { elem.removeClass('btn-spinner'); }, 4000);
    }
});

$("#formPayment").submit(function (e) {

    //Bind functions to form submit (not button click!)
    e.preventDefault();
    $('#submitButton').val('Save');
    this.submit();

});

//Edited to allow more characters than other v3 modules
$("#formPayment").find('textarea').on("input", function (e) {
    var pos = this.selectionStart;
    //replace ~`<>^*{}[]|\" with nothing
    var str = $(this).val().replace(/[\~\`\<\>\^\*{\}\[\]\|\\\"]/g, '').replace(/\.{2,}/g, '.');
    var len = str.length;
    $(this).val(str);
    this.selectionEnd = pos - (len - str.length);
});

$(document).on("keydown", ":input:not(textarea):not(:submit)", function (event) {
    if (event.keyCode == 13) {
        event.preventDefault();
        return false;
    }
});

})(jQuery);




    </script>